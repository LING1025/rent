<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.funtl.myshop.plus.provider.mapper.OrderMapper">
  <resultMap id="BaseResultMap" type="com.funtl.myshop.plus.provider.domain.Order">
    <!--@mbg.generated-->
    <!--@Table [Order]-->
    <id column="Order_Auto" jdbcType="BIGINT" property="orderAuto" />
    <result column="Orders_Auto" jdbcType="BIGINT" property="ordersAuto" />
    <result column="TradeItem_Auto" jdbcType="BIGINT" property="tradeItemAuto" />
    <result column="CarBase_Auto" jdbcType="BIGINT" property="carBaseAuto" />
    <result column="Sales_Auto" jdbcType="BIGINT" property="salesAuto" />
    <result column="OrderNo" jdbcType="VARCHAR" property="orderNo" />
    <result column="LinceNo" jdbcType="VARCHAR" property="linceNo" />
    <result column="StartDT" jdbcType="TIMESTAMP" property="startDT" />
    <result column="EndDT" jdbcType="TIMESTAMP" property="endDT" />
    <result column="ResDT" jdbcType="TIMESTAMP" property="resDT" />
    <result column="Status" jdbcType="INTEGER" property="status" />
    <result column="Memo" jdbcType="VARCHAR" property="memo" />
    <result column="Brand_Auto" jdbcType="INTEGER" property="brandAuto" />
    <result column="Clasen_Auto" jdbcType="INTEGER" property="clasenAuto" />
    <result column="ListPrice" jdbcType="DECIMAL" property="listPrice" />
    <result column="DisPrice" jdbcType="DECIMAL" property="disPrice" />
    <result column="GetPrice" jdbcType="DECIMAL" property="getPrice" />
    <result column="Accessary" jdbcType="DECIMAL" property="accessary" />
    <result column="PushMoney" jdbcType="DECIMAL" property="pushMoney" />
    <result column="CarCost" jdbcType="DECIMAL" property="carCost" />
    <result column="RentAmt" jdbcType="DECIMAL" property="rentAmt" />
    <result column="OverAmt" jdbcType="DECIMAL" property="overAmt" />
    <result column="DptAmt" jdbcType="DECIMAL" property="dptAmt" />
    <result column="MM" jdbcType="INTEGER" property="mm" />
    <result column="MAmt" jdbcType="DECIMAL" property="mAmt" />
    <result column="MakNo" jdbcType="VARCHAR" property="makNo" />
    <result column="CarTax" jdbcType="DECIMAL" property="carCost" />
    <result column="InsurePercnt" jdbcType="INTEGER" property="insurePercnt" />
    <result column="IsBusiness" jdbcType="INTEGER" property="isBusiness" />
    <result column="RentType" jdbcType="INTEGER" property="rentType" />
    <result column="UseType" jdbcType="INTEGER" property="useType" />
    <result column="CarSource" jdbcType="INTEGER" property="carSource" />
    <result column="DriverAmt" jdbcType="DECIMAL" property="driverAmt" />
    <result column="OilAmt" jdbcType="DECIMAL" property="oilAmt" />
    <result column="DriveService" jdbcType="DECIMAL" property="driveService" />
    <result column="RateKM" jdbcType="DECIMAL" property="rateKM" />
    <result column="LinceKM" jdbcType="DECIMAL" property="linceKM" />
    <result column="CarMtnAmt" jdbcType="DECIMAL" property="carMtnAmt" />
    <result column="whiel" jdbcType="INTEGER" property="whiel" />
    <result column="OverKM" jdbcType="DECIMAL" property="overKM" />
    <result column="OverKMPayType" jdbcType="INTEGER" property="overKMPayType" />
    <result column="PayMode" jdbcType="INTEGER" property="payMode" />
    <result column="PayDay" jdbcType="INTEGER" property="payDay" />
    <result column="RateRate" jdbcType="DECIMAL" property="rateRate" />
    <result column="RateInsure" jdbcType="DECIMAL" property="rateInsure" />
    <result column="RateInsureD" jdbcType="DECIMAL" property="rateInsured" />
    <result column="RateMCost" jdbcType="DECIMAL" property="rateMCost" />
    <result column="RateYCost" jdbcType="DECIMAL" property="rateYCost" />
    <result column="RateTCost" jdbcType="DECIMAL" property="rateTCost" />
    <result column="RateM" jdbcType="DECIMAL" property="rateM" />
    <result column="RateY" jdbcType="DECIMAL" property="rateY" />
    <result column="RateT" jdbcType="DECIMAL" property="rateT" />
    <result column="RateCost" jdbcType="DECIMAL" property="rateCost" />
    <result column="RateDPN" jdbcType="DECIMAL" property="rateDPN" />
    <result column="RateTax" jdbcType="DECIMAL" property="rateTax" />
    <result column="RateAmt" jdbcType="DECIMAL" property="rentAmt" />
    <result column="FinalRate" jdbcType="DECIMAL" property="finalRate" />
    <result column="FinalInsure" jdbcType="DECIMAL" property="finalInsure" />
    <result column="FinalInsureD" jdbcType="DECIMAL" property="finalInsured" />
    <result column="FinalMCost" jdbcType="DECIMAL" property="finalMCost" />
    <result column="FinalYCost" jdbcType="DECIMAL" property="finalYCost" />
    <result column="FinalTCost" jdbcType="DECIMAL" property="finalTCost" />
    <result column="FinalM" jdbcType="DECIMAL" property="finalM" />
    <result column="FinalY" jdbcType="DECIMAL" property="finalY" />
    <result column="FinalT" jdbcType="DECIMAL" property="finalT" />
    <result column="FinalCost" jdbcType="DECIMAL" property="finalCost" />
    <result column="FinalDPN" jdbcType="DECIMAL" property="finalDPN" />
    <result column="FinalTax" jdbcType="DECIMAL" property="finalTax" />
    <result column="FinalAmt" jdbcType="DECIMAL" property="finalAmt" />
    <result column="RentTotal" jdbcType="DECIMAL" property="rentTotal" />
    <result column="GrossMarginT" jdbcType="DECIMAL" property="grossMarginT" />
    <result column="GrossMargin" jdbcType="DECIMAL" property="grossMargin" />
    <result column="RentRate" jdbcType="DECIMAL" property="rateRate" />
    <result column="CUser" jdbcType="INTEGER" property="cUser" />
    <result column="CDT" jdbcType="TIMESTAMP" property="cDT" />
    <result column="MUser" jdbcType="INTEGER" property="mUser" />
    <result column="MDT" jdbcType="TIMESTAMP" property="mDT" />
    <result column="CustSource" jdbcType="INTEGER" property="custSource" />
    <result column="Arrange" jdbcType="DECIMAL" property="arrange" />
    <result column="ArrangeDay" jdbcType="BIGINT" property="arrangeDay" />
    <result column="Inc_Auto" jdbcType="BIGINT" property="incAuto" />
    <result column="RealRate" jdbcType="DECIMAL" property="realRate" />
    <result column="RealGMT" jdbcType="DECIMAL" property="realGMT" />
    <result column="RealGM" jdbcType="DECIMAL" property="realGM" />
    <result column="RealRentRate" jdbcType="DECIMAL" property="realRentRate" />
    <result column="MakNoCost" jdbcType="DECIMAL" property="makNoCost" />
    <result column="MakNoOverAmt" jdbcType="DECIMAL" property="makNoOverAmt" />
    <result column="A1" jdbcType="VARCHAR" property="a1" />
    <result column="B1" jdbcType="VARCHAR" property="b1" />
    <result column="B2" jdbcType="VARCHAR" property="b2" />
    <result column="B3" jdbcType="VARCHAR" property="b3" />
    <result column="B4" jdbcType="VARCHAR" property="b4" />
    <result column="IsCHK" jdbcType="INTEGER" property="isChk" />
    <result column="OrderType" jdbcType="INTEGER" property="orderType" />
    <result column="InvDT" jdbcType="INTEGER" property="invDT" />
    <result column="InvStop" jdbcType="INTEGER" property="invStop" />
    <result column="InvStopMemo" jdbcType="VARCHAR" property="invStopMemo" />
    <result column="StampTax" jdbcType="DECIMAL" property="stampTax" />
    <result column="SellCarTax" jdbcType="DECIMAL" property="sellCarTax" />
    <result column="IRR" jdbcType="DECIMAL" property="irr" />
    <result column="NPV" jdbcType="DECIMAL" property="npv" />
    <result column="TrnsFee" jdbcType="DECIMAL" property="trnsFee" />
    <result column="NeedFile" jdbcType="BIGINT" property="needFile" />
    <result column="MakeFile" jdbcType="BIGINT" property="makeFile" />
    <result column="NeedFileNum" jdbcType="BIGINT" property="needFileNum" />
    <result column="MakeFileNum" jdbcType="BIGINT" property="makeFileNum" />
    <result column="RentAmtReal" jdbcType="DECIMAL" property="rentAmtReal" />
    <result column="Sub_Auto" jdbcType="BIGINT" property="subAuto" />
    <result column="RealCarCost" jdbcType="DECIMAL" property="realCarCost" />
    <result column="CollMemo" jdbcType="VARCHAR" property="collMemo" />
    <result column="DPNMAmt" jdbcType="DECIMAL" property="dpnMAmt" />
    <result column="IncVirCardNo" jdbcType="VARCHAR" property="incVirCardNo" />
    <result column="RealDptAmt" jdbcType="DECIMAL" property="realDptAmt" />
    <result column="RealDptDT" jdbcType="TIMESTAMP" property="realDptDT" />
    <result column="RealDptISPrinter" jdbcType="INTEGER" property="realDptISprinter" />
    <result column="DptPrinterDT" jdbcType="TIMESTAMP" property="dptPrinterDT" />
    <result column="DptRemark" jdbcType="VARCHAR" property="dptPrinterDT" />
    <result column="OrderMemo" jdbcType="VARCHAR" property="orderMemo" />
    <result column="C1" jdbcType="VARCHAR" property="c1" />
    <result column="C2" jdbcType="VARCHAR" property="c2" />
    <result column="C3" jdbcType="VARCHAR" property="c3" />
    <result column="D1" jdbcType="VARCHAR" property="d1" />
    <result column="D2" jdbcType="VARCHAR" property="d2" />
    <result column="D3" jdbcType="VARCHAR" property="d3" />
    <result column="D4" jdbcType="VARCHAR" property="d4" />
    <result column="D5" jdbcType="VARCHAR" property="d5" />
    <result column="TaxMode" jdbcType="INTEGER" property="taxMode" />
    <result column="TaxRate" jdbcType="DECIMAL" property="taxRate" />
    <result column="chkListPrice" jdbcType="INTEGER" property="chkListPrice" />
    <result column="BoundDT" jdbcType="TIMESTAMP" property="boundDT" />
    <result column="BoundStatus" jdbcType="INTEGER" property="bonusStatus" />
    <result column="JCDT" jdbcType="TIMESTAMP" property="jcDT" />
    <result column="IsMerit" jdbcType="INTEGER" property="isMerit" />
    <result column="RunDT" jdbcType="TIMESTAMP" property="runDT" />
    <result column="YJCDT" jdbcType="TIMESTAMP" property="yjcDT" />
    <result column="YJSales" jdbcType="INTEGER" property="yjSales" />
    <result column="YJOrg" jdbcType="INTEGER" property="yjOrg" />
    <result column="Scooter" jdbcType="VARCHAR" property="scooter" />
    <result column="DisType" jdbcType="INTEGER" property="disPrice" />
    <result column="InvStopEndDT" jdbcType="TIMESTAMP" property="invStopMemo" />
    <result column="IsBonus" jdbcType="INTEGER" property="isBonus" />
    <result column="IsRemoveOverdue" jdbcType="INTEGER" property="isRemoveOverdue" />
    <result column="BonusStatus" jdbcType="INTEGER" property="bonusStatus" />
    <result column="BonusYY" jdbcType="INTEGER" property="bonusYY" />
    <result column="BonusMM" jdbcType="INTEGER" property="bonusMM" />
    <result column="BonusAmt" jdbcType="DECIMAL" property="bonusAmt" />
    <result column="IsLawEnd" jdbcType="INTEGER" property="isLawEnd" />
    <result column="ReletMakno" jdbcType="VARCHAR" property="reletMakNo" />
    <result column="IsRelet" jdbcType="INTEGER" property="isRelet" />
    <result column="DptAmtTrnDT" jdbcType="TIMESTAMP" property="dptAmtTrnDT" />
    <result column="BonusRate" jdbcType="DECIMAL" property="bonusRate" />
    <result column="BonusCarCost" jdbcType="DECIMAL" property="bonusCarCost" />
    <result column="IsBlack" jdbcType="INTEGER" property="isBlack" />
    <result column="BlackDT" jdbcType="TIMESTAMP" property="blackDT" />
    <result column="OutFee" jdbcType="DECIMAL" property="outFee" />
    <result column="FinanceFee" jdbcType="DECIMAL" property="financeFee" />
    <result column="UrgentFee" jdbcType="DECIMAL" property="urgentFee" />
    <result column="QJRemark" jdbcType="VARCHAR" property="qJRemark" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--@mbg.generated-->
    Order_Auto, Orders_Auto, TradeItem_Auto, CarBase_Auto, Sales_Auto, OrderNo, LinceNo,
    StartDT, EndDT, ResDT, [Status], Memo, Brand_Auto, Clasen_Auto, ListPrice, DisPrice,
    GetPrice, Accessary, PushMoney, CarCost, RentAmt, OverAmt, DptAmt, MM, MAmt, MakNo,
    CarTax, InsurePercnt, IsBusiness, RentType, UseType, CarSource, DriverAmt, OilAmt,
    DriveService, RateKM, LinceKM, CarMtnAmt, whiel, OverKM, OverKMPayType, PayMode,
    PayDay, RateRate, RateInsure, RateInsureD, RateMCost, RateYCost, RateTCost, RateM,
    RateY, RateT, RateCost, RateDPN, RateTax, RateAmt, FinalRate, FinalInsure, FinalInsureD,
    FinalMCost, FinalYCost, FinalTCost, FinalM, FinalY, FinalT, FinalCost, FinalDPN,
    FinalTax, FinalAmt, RentTotal, GrossMarginT, GrossMargin, RentRate, CUser, CDT, MUser,
    MDT, CustSource, Arrange, ArrangeDay, Inc_Auto, RealRate, RealGMT, RealGM, RealRentRate,
    MakNoCost, MakNoOverAmt, A1, B1, B2, B3, B4, IsCHK, OrderType, InvDT, InvStop, InvStopMemo,
    StampTax, SellCarTax, IRR, NPV, TrnsFee, NeedFile, MakeFile, NeedFileNum, MakeFileNum,
    RentAmtReal, Sub_Auto, RealCarCost, CollMemo, DPNMAmt, IncVirCardNo, RealDptAmt,
    RealDptDT, RealDptISPrinter, DptPrinterDT, DptRemark, OrderMemo, C1, C2, C3, D1,
    D2, D3, D4, D5, TaxMode, TaxRate, chkListPrice, BoundDT, BoundStatus, JCDT, IsMerit,
    RunDT, YJCDT, YJSales, YJOrg, Scooter, DisType, InvStopEndDT, IsBonus, IsRemoveOverdue,
    BonusStatus, BonusYY, BonusMM, BonusAmt, IsLawEnd, ReletMakno, IsRelet, DptAmtTrnDT,
    BonusRate, BonusCarCost, IsBlack, BlackDT, OutFee, FinanceFee, UrgentFee, QJRemark
  </sql>

  <resultMap id="queryCaseProList" type="com.funtl.myshop.plus.provider.domain.CaseProList">
    <result column="CompanyName" jdbcType="VARCHAR" property="companyName" />
    <result column="DepNAme" jdbcType="VARCHAR" property="depName" />
    <result column="FNAme" jdbcType="VARCHAR" property="fName" />
    <result column="CustName" jdbcType="VARCHAR" property="custName" />
    <result column="SName" jdbcType="VARCHAR" property="sName" />
    <result column="ClasenName" jdbcType="VARCHAR" property="clasenName" />
    <result column="makNo" jdbcType="VARCHAR" property="makNo" />
    <result column="Order_Auto" jdbcType="BIGINT" property="orderAuto" />
    <result column="CustSourceName" jdbcType="VARCHAR" property="custSourceName" />
    <result column="RentTypeName" jdbcType="VARCHAR" property="rentTypeName" />
    <result column="OrderTypeName" jdbcType="VARCHAR" property="orderTypeName" />
    <result column="ListPrice" jdbcType="DECIMAL" property="listPrice" />

    <result column="SalesAMT" jdbcType="DECIMAL" property="salesAMT" />
    <result column="bonusRate" jdbcType="DECIMAL" property="bonusRate" />
    <result column="CarMtnAmt" jdbcType="DECIMAL" property="carMtnAmt" />

    <result column="EndDT" jdbcType="TIMESTAMP" property="endDT" />
    <result column="RealDptDT" jdbcType="TIMESTAMP" property="realDptDT" />
    <result column="MakDT" jdbcType="TIMESTAMP" property="makDT" />
    <result column="JCDT" jdbcType="TIMESTAMP" property="jcDT" />
    <result column="ContractSignet" jdbcType="TIMESTAMP" property="contractSignet" />

    <result column="OrderStatus" jdbcType="VARCHAR" property="orderStatus" />
    <result column="QiPiao" jdbcType="DECIMAL" property="qiPiao" />
    <result column="IsTruck" jdbcType="VARCHAR" property="isTruck" />
    <result column="InsureMM" jdbcType="INTEGER" property="insureMM" />
    <result column="InsureAmt" jdbcType="DECIMAL" property="insureAmt" />
  </resultMap>
    <select id="selectCaseProList" resultMap="queryCaseProList">
      declare
      @inc int,--公司别
      @type int,--查询类别
      @year int,--年份
      @month int,--月份
      @flag int,--单选按钮
      @customer varchar(100)--输入条件
      set   @inc = #{param.inc}
      set	@type = #{param.type}
      set	@year = #{param.year}
      set	@month = #{param.month}
      set	@flag = #{param.flag}
      set	@customer = #{param.customer}

      BEGIN
      declare @order table(
      order_auto bigint,
      orders_auto bigint
      )

      insert into @order
      select distinct a.Order_Auto,a.orders_auto
      from [order] a  (nolock)
      inner join tradeitem c  (nolock) on a.tradeitem_auto=c.tradeitem_auto
      left join Credit_Order f  (nolock) on a.Orders_Auto=f.Orders_Auto
      inner join CreditMainInfo g  (nolock) on f.CreditMain_Auto=g.CreditMain_Auto and g.CreditStatus>=10
      left join BookCar i (nolock)  on g.CreditMain_Auto=i.CreditMain_Auto
      left join BookCarNote k (nolock)  on k.CreditMain_Auto=g.CreditMain_Auto and k.Status=1
      where  a.OrderType in(1,5,6) and (a.Inc_Auto=@inc or @inc=0) and
      (
      (@customer!='' and c.FName like '%'+@customer+'%' and (a.YJCDT is null or a.JCDT is null)) or
      ((@customer ='') and (
      (
      (@flag=0 and
      ((@type=1 and
      (
      (isnull(a.DptAmt,0)>0 and ( ((@month between 2 and 11) and ((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month-1 and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )>=21) or (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )&lt;=20)))
      or (@month=1 and DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )&lt;=20)
      or (@month=12 and ((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month-1 and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )>=21) or (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month))) ) and DATEPART(YYYY,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@year)
      or
      (isnull(a.DptAmt,0)=0 and ( ((@month between 2 and 11) and ((DATEPART(MM,i.EndDT)=@month-1 and DATEPART(DD,i.EndDT)>=21) or (DATEPART(MM,i.EndDT)=@month and DATEPART(DD,i.EndDT)&lt;=20)))
      or (@month=1 and DATEPART(MM,i.EndDT)=@month and DATEPART(DD,i.EndDT)&lt;=20)
      or (@month=12 and ((DATEPART(MM,i.EndDT)=@month-1 and DATEPART(DD,i.EndDT)>=21) or (DATEPART(MM,i.EndDT)=@month))) ) and DATEPART(YYYY,i.EndDT)=@year)
      )
      )
      or (@type=2 and ( ((@month between 2 and 11) and ((DATEPART(MM,a.JCDT)=@month-1 and DATEPART(DD,a.JCDT)>=21) or (DATEPART(MM,a.JCDT)=@month and DATEPART(DD,a.JCDT)&lt;=20)) )
      or (@month=1 and DATEPART(MM,a.JCDT)=@month and DATEPART(DD,a.JCDT)&lt;=20)
      or (@month=12 and ((DATEPART(MM,a.JCDT)=@month-1 and DATEPART(DD,a.JCDT)>=21) or (DATEPART(MM,a.JCDT)=@month))) )  and DATEPART(YYYY,a.JCDT)=@year)
      or (@type=3 and ( ((@month between 2 and 11) and ((DATEPART(MM,a.BoundDT)=@month-1 and DATEPART(DD,a.BoundDT)>=21) or (DATEPART(MM,a.BoundDT)=@month and DATEPART(DD,a.BoundDT)&lt;=20)) )
      or (@month=1 and DATEPART(MM,a.BoundDT)=@month and DATEPART(DD,a.BoundDT)&lt;=20)
      or (@month=12 and ((DATEPART(MM,a.BoundDT)=@month-1 and DATEPART(DD,a.BoundDT)>=21) or (DATEPART(MM,a.BoundDT)=@month))) )  and DATEPART(YYYY,a.BoundDT)=@year)
      or (@type=4 and ( ((@month between 2 and 11) and ((DATEPART(MM,a.YJCDT)=@month-1 and DATEPART(DD,a.YJCDT)>=21) or (DATEPART(MM,a.YJCDT)=@month and DATEPART(DD,a.YJCDT)&lt;=20)) )
      or (@month=1 and DATEPART(MM,a.YJCDT)=@month and DATEPART(DD,a.YJCDT)&lt;=20)
      or (@month=12 and ((DATEPART(MM,a.YJCDT)=@month-1 and DATEPART(DD,a.YJCDT)>=21) or (DATEPART(MM,a.YJCDT)=@month))) )  and DATEPART(YYYY,a.YJCDT)=@year)
      or (
      @type=5 and isnull(case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end,'') &lt;>'' and (
      (( ((@month between 2 and 11) and ((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month-1 and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )>=21) or (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )&lt;=20)))
      or (@month=1 and DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )&lt;=20)
      or (@month=12 and ((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month-1 and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )>=21) or (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month))) ) and DATEPART(YYYY,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@year
      )
      or
      (( ((@month between 2 and 11) and ((DATEPART(MM,a.JCDT)=@month-1 and DATEPART(DD,a.JCDT)>=21) or (DATEPART(MM,a.JCDT)=@month and DATEPART(DD,a.JCDT)&lt;=20)) )
      or (@month=1 and DATEPART(MM,a.JCDT)=@month and DATEPART(DD,a.JCDT)&lt;=20)
      or (@month=12 and ((DATEPART(MM,a.JCDT)=@month-1 and DATEPART(DD,a.JCDT)>=21) or (DATEPART(MM,a.JCDT)=@month))) )  and DATEPART(YYYY,a.JCDT)=@year
      )
      or (a.JCDT is null )
      )
      )
      )
      )
      or (@flag=1 and
      (
      (@type=1 and (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(YYYY,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@year))
      or (@type=2 and (DATEPART(MM,a.JCDT)=@month and DATEPART(YYYY,a.JCDT)=@year))
      or (@type=3 and (DATEPART(MM,a.BoundDT)=@month and DATEPART(YYYY,a.BoundDT)=@year))
      or (@type=4 and (DATEPART(MM,a.YJCDT)=@month and DATEPART(YYYY,a.YJCDT)=@year))
      or (
      @type=5 and isnull(case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end,'') &lt;>'' and (
      ((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(YYYY,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@year))
      or
      ((DATEPART(MM,a.JCDT)=@month and DATEPART(YYYY,a.JCDT)=@year))
      or (a.JCDT is null)
      )
      )
      ))
      )
      or (case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when RTRIM(k.txtruzhang1) = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end &lt;'2013/11/21' and a.Order_Auto in(6064,4325,4326,6067,6061,5963,6065,6017,6068,5984,5993,5962,6047,5981,6002,5870,6013,6014,6071,6042)
      and (a.JCDT='' or a.JCDT is null) and @type&lt;>4
      )
      ))
      )

      select CompanyName=h.SName,b1.DepName,b.FNAme,CustName=c.FName,c.SName,L.FactoryBrandName+'-'+ e.ClasenName ClasenName,d.MakNo,a.Order_Auto
      ,CustSourceName=dbo.f_GetItemName(313,a.CustSource),RentTypeName=dbo.f_GetItemName(314,a.RentType),OrderTypeName = n.ItemName --case a.OrderType when 1 then '长租' when 5 then '融资' when 9 then '公务车' else '' end
      ,a.ListPrice,a.MM,a.MAmt,SalesAMT=a.MM*a.MAMT,case when a.IsBonus = 1 or a.Status >= 30 or a.IsCHK = 1 then a.BonusRate else 0.00 end BonusRate
      ,a.CarMtnAmt,i.EndDT
      ,RealDptDT=case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end
      ,d.MakDT,
      ISNULL(a.JCDT,m.deliveryDT) as JCDT,
      g.ContractSignet,a.BoundDT,a.YJCDT
      ,OrderStatus=case when j.OrderStatus=10 then '变更中' when j.OrderStatus>=20 then '完成' end
      ,QiPiao=case when j.OrderType = 8 then a.CarCost-a.StampTax else (a.ListPrice-a.DisPrice-case when a.RentType = 2 and isnull(j.OverAmt_Y,0) > 0 then j.OverAmt else a.OverAmt end) end
      ,case when o.ItemName like '%货车%' then '货车' else case when j.Onetime = 1 then '一次性' else p.ItemName end end IsTruck
      ,q.InsureMM
      ,q.InsureAmt
      ,a.BonusStatus
      from @order aa
      left join [order] a  (nolock) on a.Order_Auto = aa.order_auto
      inner join v_emp b (nolock)  on a.YJSales=b.User_Auto--a.Sales_auto=b.User_Auto  YJSales,YJOrg
      inner join AspNet.dbo.Org b1 (nolock)  on b1.Org_Auto = a.YJOrg
      inner join tradeitem c  (nolock) on a.tradeitem_auto=c.tradeitem_auto
      inner join Carbase d  (nolock) on a.Carbase_auto=d.Carbase_auto
      inner join Clasen e  (nolock) on a.clasen_auto=e.clasen_auto
      inner join Inc h  (nolock) on a.Inc_Auto=h.Inc_Auto
      left join FactoryBrand l  (nolock) on l.FactoryBrand_Auto=d.FactoryBrand_Auto
      left join Credit_Order f  (nolock) on a.Orders_Auto=f.Orders_Auto
      left join CreditMainInfo g  (nolock) on f.CreditMain_Auto=g.CreditMain_Auto
      left join BookCar i  (nolock) on g.CreditMain_Auto=i.CreditMain_Auto
      left join Orders j  (nolock) on a.Orders_Auto=j.Orders_Auto
      LEFT JOIN DEliverycar m  (nolock) on m.Order_auto=a.Order_Auto AND M.[Status]=1 AND M.ReturnVisit_Auto>0
      left join BookCarNote k (nolock)  on k.CreditMain_Auto=g.CreditMain_Auto and k.Status=1
      left join ItemCode n  (nolock) on n.ItemType = 326 and n.Num = j.OrderType
      left join ItemCode o  (nolock) on o.ItemType = 410 and o.Num = d.InsurePercnt
      left join ItemCode p  (nolock) on p.ItemType = 503 and p.Num = j.CarSource
      left join (	select k1.Order_Auto,
      sum(case when k3.InsureType = 2 then 1 else 0 end * 12  - case when k2.MM%12 > 0 and k3.InsureType = 2 and k3.InsureYear = k2.MM/12 then 12 - k2.MM%12 else 0 end) InsureMM ,
      sum(case when k3.InsureType = 2 and k3.InsureYear = 1 then k3.InsureRealAmt else 0 end) InsureAmt
      from @Order k1
      left join orders k2 on k2.Orders_Auto = k1.Orders_Auto
      left join OrdersInsureList k3 on k3.Orders_Auto = k2.Orders_Auto and k3.InsureType = 2
      group by k1.Order_Auto,k2.MM,k2.IsCustomerCare)q on q.order_auto = a.Order_Auto

      Order by DepName,FName
      end

    </select>
  <resultMap id="queryCaseExecList" type="com.funtl.myshop.plus.provider.domain.CaseExecList">
    <result column="DepNAme" jdbcType="VARCHAR" property="depName" />
    <result column="FNAme" jdbcType="VARCHAR" property="fName" />
    <result column="TradeItem_Auto" jdbcType="BIGINT" property="tradeItemAuto" />
    <result column="comFName" jdbcType="VARCHAR" property="comFName" />
      <result column="idenType" jdbcType="VARCHAR" property="idenType" />
      <result column="sName" jdbcType="VARCHAR" property="sName" />
      <result column="statusName" jdbcType="VARCHAR" property="statusName" />
      <result column="makNo" jdbcType="VARCHAR" property="makNo" />
      <result column="category" jdbcType="VARCHAR" property="category" />
      <result column="custSource" jdbcType="VARCHAR" property="custSource" />
      <result column="rentType" jdbcType="VARCHAR" property="rentType" />
      <result column="factoryBrandName" jdbcType="VARCHAR" property="factoryBrandName" />
      <result column="clasenName" jdbcType="VARCHAR" property="clasenName" />
      <result column="carColor" jdbcType="VARCHAR" property="carColor" />
      <result column="sellerFName" jdbcType="VARCHAR" property="sellerFName" />
      <result column="totalAmt" jdbcType="DECIMAL" property="totalAmt" />
      <result column="MakDT" jdbcType="TIMESTAMP" property="makDT" />
      <result column="disPriceTax" jdbcType="DECIMAL" property="disPriceTax" />
      <result column="pushMoney" jdbcType="DECIMAL" property="pushMoney" />
      <result column="salvage" jdbcType="DECIMAL" property="salvage" />
      <result column="loanAmount" jdbcType="DECIMAL" property="loanAmount" />
      <result column="creditLevel" jdbcType="VARCHAR" property="creditLevel" />
      <result column="CreditMain_Auto" jdbcType="BIGINT" property="creditMainAuto" />
      <result column="contractNo" jdbcType="VARCHAR" property="contractNo" />
      <result column="forDT" jdbcType="TIMESTAMP" property="forDT" />
      <result column="payType" jdbcType="VARCHAR" property="payType" />
      <result column="carSource" jdbcType="VARCHAR" property="carSource" />
      <result column="businessType" jdbcType="VARCHAR" property="businessType" />
      <result column="businessOrdersType" jdbcType="VARCHAR" property="businessOrdersType" />
      <result column="realAmt" jdbcType="DECIMAL" property="realAmt" />
      <result column="accRealAmt" jdbcType="DECIMAL" property="accRealAmt" />
      <result column="useType" jdbcType="VARCHAR" property="useType" />
      <result column="onetime" jdbcType="VARCHAR" property="onetime" />
      <result column="projectName" jdbcType="VARCHAR" property="projectName" />
      <result column="trucks" jdbcType="VARCHAR" property="trucks" />
      <result column="comType" jdbcType="VARCHAR" property="comType" />
      <result column="insureMM" jdbcType="INTEGER" property="insureMM" />
      <result column="insureAmt" jdbcType="DECIMAL" property="insureAmt" />
      <result column="inCome" jdbcType="DECIMAL" property="inCome" />
      <result column="carCost" jdbcType="DECIMAL" property="carCost" />
      <result column="budgetAmt" jdbcType="DECIMAL" property="budgetAmt" />
    <result column="Order_Auto" jdbcType="BIGINT" property="orderAuto" />
    <!--<result column="JCDT" jdbcType="TIMESTAMP" property="jcDT" />
    <result column="deliveryDT" jdbcType="TIMESTAMP" property="deliveryDT" />-->
  </resultMap>
  <select id="selectCaseExecList" resultMap="queryCaseExecList">
    declare
    @inc int,<!--公司别-->
      @type int,<!--查询类别-->
      @year int,<!--年份-->
      @month int,<!--月份-->
      @flag int,<!--单选按钮-->
      @customer varchar(100)<!--输入条件-->
      set   @inc = #{param.inc}
      set	@type = #{param.type}
      set	@year = #{param.year}
      set	@month = #{param.month}
      set	@flag = #{param.flag}
      set	@customer = #{param.customer}
BEGIN
	declare @order table(
	order_auto bigint,
	orders_auto bigint
	)

	insert into @order
	select distinct a.Order_Auto,a.orders_auto
	from [order] a  (nolock)
	inner join tradeitem c  (nolock) on a.TradeItem_Auto=c.TradeItem_Auto
	left join Credit_Order f (nolock)  on a.Orders_Auto=f.Orders_Auto
	inner join CreditMainInfo g (nolock)  on f.CreditMain_Auto=g.CreditMain_Auto and g.CreditStatus>=10
	left join BookCar i  (nolock) on g.CreditMain_Auto=i.CreditMain_Auto
	left join BookCarNote k  (nolock) on k.CreditMain_Auto=g.CreditMain_Auto and k.Status=1
	where  a.OrderType in(1,5,6) and (a.Inc_Auto=@inc or @inc=0) and
		(
			(@customer!='' and c.FName like '%'+@customer+'%' and (a.YJCDT is null or a.JCDT is null)) or
			((@customer ='') and (
			(
				(@flag=0 and
					((@type=1 and
						(
							(isnull(a.DptAmt,0)>0 and ( ((@month between 2 and 11) and ((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month-1 and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )>=21) or (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )&lt;=20)))
							or (@month=1 and DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )&lt;=20)
							or (@month=12 and ((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month-1 and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )>=21) or (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month))) ) and DATEPART(YYYY,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@year)
							or
							(isnull(a.DptAmt,0)=0 and ( ((@month between 2 and 11) and ((DATEPART(MM,i.EndDT)=@month-1 and DATEPART(DD,i.EndDT)>=21) or (DATEPART(MM,i.EndDT)=@month and DATEPART(DD,i.EndDT)&lt;=20)))
							or (@month=1 and DATEPART(MM,i.EndDT)=@month and DATEPART(DD,i.EndDT)&lt;=20)
							or (@month=12 and ((DATEPART(MM,i.EndDT)=@month-1 and DATEPART(DD,i.EndDT)>=21) or (DATEPART(MM,i.EndDT)=@month))) ) and DATEPART(YYYY,i.EndDT)=@year)
						)
					)
					or (@type=2 and ( ((@month between 2 and 11) and ((DATEPART(MM,a.JCDT)=@month-1 and DATEPART(DD,a.JCDT)>=21) or (DATEPART(MM,a.JCDT)=@month and DATEPART(DD,a.JCDT)&lt;=20)) )
					or (@month=1 and DATEPART(MM,a.JCDT)=@month and DATEPART(DD,a.JCDT)&lt;=20)
					or (@month=12 and ((DATEPART(MM,a.JCDT)=@month-1 and DATEPART(DD,a.JCDT)>=21) or (DATEPART(MM,a.JCDT)=@month))) )  and DATEPART(YYYY,a.JCDT)=@year)
					or (@type=3 and ( ((@month between 2 and 11) and ((DATEPART(MM,a.BoundDT)=@month-1 and DATEPART(DD,a.BoundDT)>=21) or (DATEPART(MM,a.BoundDT)=@month and DATEPART(DD,a.BoundDT)&lt;=20)) )
					or (@month=1 and DATEPART(MM,a.BoundDT)=@month and DATEPART(DD,a.BoundDT)&lt;=20)
					or (@month=12 and ((DATEPART(MM,a.BoundDT)=@month-1 and DATEPART(DD,a.BoundDT)>=21) or (DATEPART(MM,a.BoundDT)=@month))) )  and DATEPART(YYYY,a.BoundDT)=@year)
					or (@type=4 and ( ((@month between 2 and 11) and ((DATEPART(MM,a.YJCDT)=@month-1 and DATEPART(DD,a.YJCDT)>=21) or (DATEPART(MM,a.YJCDT)=@month and DATEPART(DD,a.YJCDT)&lt;=20)) )
					or (@month=1 and DATEPART(MM,a.YJCDT)=@month and DATEPART(DD,a.YJCDT)&lt;=20)
					or (@month=12 and ((DATEPART(MM,a.YJCDT)=@month-1 and DATEPART(DD,a.YJCDT)>=21) or (DATEPART(MM,a.YJCDT)=@month))) )  and DATEPART(YYYY,a.YJCDT)=@year)
					or (
						@type=5 and isnull(case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end,'') &lt;>'' and (
							(( ((@month between 2 and 11) and ((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month-1 and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )>=21) or (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )&lt;=20)))
							or (@month=1 and DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )&lt;=20)
							or (@month=12 and ((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month-1 and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )>=21) or (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month))) ) and DATEPART(YYYY,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@year
							)
							or
							(( ((@month between 2 and 11) and ((DATEPART(MM,a.JCDT)=@month-1 and DATEPART(DD,a.JCDT)>=21) or (DATEPART(MM,a.JCDT)=@month and DATEPART(DD,a.JCDT)&lt;=20)) )
							or (@month=1 and DATEPART(MM,a.JCDT)=@month and DATEPART(DD,a.JCDT)&lt;=20)
							or (@month=12 and ((DATEPART(MM,a.JCDT)=@month-1 and DATEPART(DD,a.JCDT)>=21) or (DATEPART(MM,a.JCDT)=@month))) )  and DATEPART(YYYY,a.JCDT)=@year
							)
							or (a.JCDT is null )
						)
					)
					)
				)
				or (@flag=1 and
					(
						(@type=1 and (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(YYYY,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@year))
						or (@type=2 and (DATEPART(MM,a.JCDT)=@month and DATEPART(YYYY,a.JCDT)=@year))
						or (@type=3 and (DATEPART(MM,a.BoundDT)=@month and DATEPART(YYYY,a.BoundDT)=@year))
						or (@type=4 and (DATEPART(MM,a.YJCDT)=@month and DATEPART(YYYY,a.YJCDT)=@year))
						or (
							@type=5 and isnull(case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end,'') &lt;>'' and (
								((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(YYYY,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@year))
								or
								((DATEPART(MM,a.JCDT)=@month and DATEPART(YYYY,a.JCDT)=@year))
								or (a.JCDT is null)
							)
						)
				))
			)
			or (case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end &lt;'2013/11/21' and a.Order_Auto in(6064,4325,4326,6067,6061,5963,6065,6017,6068,5984,5993,5962,6047,5981,6002,5870,6013,6014,6071,6042)
			and (a.JCDT='' or a.JCDT is null) and @type&lt;>4
			)
			))
		)

	select a.Order_Auto,sum(b.InCome + b.InComePre) InCome
	into #C
	from @Order a
	left join OrderRent b on b.Order_Auto = a.Order_Auto
	group by a.Order_Auto

	select a.Order_Auto
	,sum(case b.CountMode when 0 then Amt when 12 then isnull(Amt*1.0/12 * c.MM,0) when 1 then isnull(case when b.type_auto = 3 then Amt*1.0/12 else Amt end,0) * c.MM end) BudgetAmt
	into #D
	from @Order a
	left join OrderBudget b on b.Order_Auto = a.Order_Auto and b.type_auto &lt;> 0
	left join [order] c on c.Order_Auto = a.Order_Auto
	group by a.Order_Auto

	select b1.DepName depName,b.FNAme fName,a.OrderNo, c.TradeItem_Auto,c.FName comFName,case when q.identype = 1 then '是' else '' end	idenType,h.SName sName
	,case when a.status=30 then '正常' when a.status=40 then '解约' when a.status=10 then '送件' else '暂存' end statusName
	,d.MakNo makNo,dbo.f_GetItemName(226,d.Category) category,dbo.f_GetItemName(313,a.CustSource) custSource,dbo.f_GetItemName(314,a.RentType) rentType,L.FactoryBrandName factoryBrandName,m.BrandName brandName,e.ClasenName clasenName
	,d.CarColor carColor,n.FName sellerFName,a.MAmt ,a.MAmt*a.MM totalAmt,d.MakDT makDT
	,a.ListPrice ,a.GetPrice ,a.DisPrice ,Convert(decimal(16,2), a.DisPrice /case when a.ListPrice > 0 then a.ListPrice else 1 end * 100) disPriceTax,a.Accessary ,j.PushMoney pushMoney,case when a.RentType = 2 and isnull(j.OverAmt_Y,0) > 0 then j.OverAmt else a.OverAmt end salvage,a.DptAmt ,a.CarMtnAmt ,case when j.OrderType = 8 then a.CarCost-a.StampTax else a.ListPrice-a.DisPrice-case when a.RentType = 2 and isnull(j.OverAmt_Y,0) > 0 then j.OverAmt else a.OverAmt end end loanAmount
	,a.StartDT ,a.EndDT ,a.MM ,dbo.f_GetItemName(115,g.Creditlevle) creditLevel
	,a.Order_Auto ,g.CreditMain_Auto,g.ContractNo contractNo
	,ISNULL(a.JCDT,t.deliveryDT) forDT
	,dbo.f_GetItemName(1001,g.PayType)payType
	,case j.CarSource when 1 then '新车' when 2 then '调度中心' when 3  then '原车续租' when 4 then '外购二手车' end carSource,a.RentRate
	, a.finalrate , a.rentamt ,a.BonusRate
	,s.ItemName businessType
	,s1.ItemName businessOrdersType
	,isnull(o.RealAmt,0) realAmt,isnull(p.RealAmt,0) accRealAmt,a.YJCDT ,dbo.f_GetItemName(225,d.UseType)  useType,case when j.Onetime = 1 then '是' else '' end onetime
	,isnull(r.Project_Name,'') projectName
	,case when u.ItemName like '%货车%' then '货车' else case when j.Onetime = 1 then '一次性' else v.ItemName end end trucks
	,w.ItemName comType
	,x.InsureMM insureMM
	,x.InsureAmt insureAmt
	,a.CarTax carTax
    ,isnull(a1.InCome,0) inCome
	,j.CarCost carCost
	,isnull(a2.BudgetAmt,0)  budgetAmt
		from @order aa
		left join [order] a (nolock) on a.Order_Auto = aa.order_auto
		inner join v_emp b  (nolock) on a.YJSales=b.User_Auto
		inner join AspNet.dbo.Org b1  (nolock) on b1.Org_Auto = a.YJOrg
		inner join tradeitem c  (nolock) on a.TradeItem_Auto=c.TradeItem_Auto
		inner join Carbase d  (nolock) on a.Carbase_auto=d.Carbase_auto
		inner join Clasen e  (nolock) on a.clasen_auto=e.clasen_auto
		inner join Brand m  (nolock) on a.Brand_Auto=m.Brand_Auto
		inner join Inc h  (nolock) on a.Inc_Auto=h.Inc_Auto
		left join FactoryBrand l  (nolock) on l.FactoryBrand_Auto=d.FactoryBrand_Auto
		left join Credit_Order f  (nolock) on a.Orders_Auto=f.Orders_Auto
		inner join CreditMainInfo g  (nolock) on f.CreditMain_Auto=g.CreditMain_Auto and g.CreditStatus>=10
		left join Orders j  (nolock) on a.Orders_Auto=j.Orders_Auto
		left join TradeItem n  (nolock) on n.TradeItem_Auto = d.supplier
		left join dpn o  (nolock) on o.Order_Auto = a.Order_Auto and o.DPN_Type = 2
		left join dpn p  (nolock) on p.Order_Auto = a.Order_Auto and p.DPN_Type = 3
		left join Customer q  (nolock) on q.TradeItem_Auto = c.TradeItem_Auto
		left join Orders_Project r (nolock)  on r.Project_Auto = j.Project_Auto
		left join ItemCode s (nolock)  on s.ItemType = 326 and s.Num = a.OrderType
		left join ItemCode s1 (nolock) on s1.ItemType = 326 and s1.Num = j.OrderType
		LEFT JOIN DEliverycar t  (nolock) on t.Order_auto=a.Order_Auto AND t.[Status]=1 AND t.ReturnVisit_Auto>0
		left join ItemCode u  (nolock) on u.ItemType = 410 and u.Num = d.InsurePercnt
		left join ItemCode v  (nolock) on v.ItemType = 503 and v.Num = j.CarSource
		left join ItemCode w  (nolock) on w.ItemType = 111 and w.Num = q.IncType
		left join (	select k1.Order_Auto,
			sum(case when k3.InsureType = 2 then 1 else 0 end * 12  - case when k2.MM%12 > 0 and k3.InsureType = 2 and k3.InsureYear = k2.MM/12 then 12 - k2.MM%12 else 0 end) InsureMM  ,
			sum(case when k3.InsureType = 2 and k3.InsureYear = 1 then k3.InsureRealAmt else 0 end) InsureAmt
			from @Order k1
			left join orders k2 on k2.Orders_Auto = k1.Orders_Auto
			left join OrdersInsureList k3 on k3.Orders_Auto = k2.Orders_Auto and k3.InsureType = 2
			group by k1.Order_Auto,k2.MM,k2.IsCustomerCare)x on x.order_auto = a.Order_Auto
	left join #C a1 on a1.Order_Auto = a.Order_Auto
	left join #D a2 on a2.Order_Auto = a.Order_Auto
	Order by b1.DepName,b.FNAme

	drop table #C
	drop table #D
end
  </select>

  <resultMap id="queryThisMonGoal" extends="BaseResultMap" type="com.funtl.myshop.plus.provider.domain.ThisMonthTar">
    <result column="newExs" jdbcType="DECIMAL" property="newExs" />
    <result column="retain" jdbcType="DECIMAL" property="retain" />
    <result column="introduce" jdbcType="DECIMAL" property="introduce" />
    <result column="totalNumAmt" jdbcType="DECIMAL" property="totalNumAmt" />
  </resultMap>
  <select id="selectThisMonGoal" resultMap="queryThisMonGoal">
    declare @Amt decimal(16,2),@Mode int,@User_Auto int,@StartDT datetime,@EndDT datetime,@Org_auto int,@OrgUp int
    set @User_Auto = #{param.userAuto}
    set @StartDT = #{param.startDate}
    set @EndDT = #{param.endDate}
    set @Org_auto =  0
    set @OrgUp =  0
    set @Mode =  0  -- 2部 1课  0业代

    select @Amt = num from ItemCode where ItemType = (10000+year(@StartDT))

    declare @Org table(
    Org_Auto bigint
    )

    select c.Roles_Auto
    into #Roles
    from AspNet.dbo.aspnet_Users a
    inner join AspNet.dbo.aspnet_UsersInRoles b on b.UserId = a.UserId
    inner join AspNet.dbo.aspnet_Roles c on c.RoleId = b.RoleId and c.Roles_Auto in(16,12,22,83,7,3,11)
    where a.User_Auto = @User_Auto

    if @OrgUp + @Org_auto > 0
    begin
    if Exists (select * from #Roles where Roles_Auto in(3,11,7))
    begin
    set @User_Auto = 0
    end
    if @OrgUp > 0
    begin
    set @Mode = 1
    insert into @Org(Org_Auto)
    select distinct b.Org_Auto
    from AspNet.dbo.Org2Emp a
    left join AspNet.dbo.Org b on b.Org_Auto = a.Org_Auto
    where (a.User_Auto = @User_Auto or @User_Auto= 0) and a.acltype = 0 and b.Lev = 5 and b.UpUnit = @OrgUp
    end
    else
    begin
    set @Mode = 0
    insert into @Org(Org_Auto)
    select distinct b.Org_Auto
    from AspNet.dbo.Org2Emp a
    left join AspNet.dbo.Org b on b.Org_Auto = a.Org_Auto
    where (a.User_Auto = @User_Auto or @User_Auto= 0) and a.acltype = 0 and b.Lev = 5 and a.Org_auto = @Org_auto
    end
    end
    else
    begin
    if Exists (select * from #Roles where Roles_Auto in(3,11,7))
    begin
    set @Mode = 2
    insert into @Org(Org_Auto)
    select distinct b.Org_Auto
    from AspNet.dbo.Org a
    left join AspNet.dbo.Org b on b.UpUnit = a.Org_Auto
    where a.IsSalesDep = 1 and a.Lev = 4  and a.iszf = 1 and (a.depname like '%华东%' or a.depname like '%华南%')
    end
    else if Exists (select * from #Roles where Roles_Auto in(12,22,83,7))
    begin
    set @Mode = 2
    insert into @Org(Org_Auto)
    select distinct b.Org_Auto
    from AspNet.dbo.Org2Emp a
    left join AspNet.dbo.Org b on b.Org_Auto = a.Org_Auto
    where a.User_Auto = @User_Auto and a.acltype = 0 and b.Lev = 5 and b.IsSalesDep = 1 and b.iszf = 1 and (b.depname like '%华东%' or b.depname like '%华南%')
    end
    else if Exists (select * from #Roles where Roles_Auto in(16))
    begin
    set @Mode = 1
    insert into @Org(Org_Auto)
    select distinct b.Org_Auto
    from AspNet.dbo.Org2Emp a
    left join AspNet.dbo.Org b on b.Org_Auto = a.Org_Auto
    where a.User_Auto = @User_Auto and a.acltype = 0 and b.Lev = 5 and b.IsSalesDep = 1 and b.iszf = 1 and (b.depname like '%华东%' or b.depname like '%华南%')
    end
    end

    if @Mode > 0
    begin
    select Mode,Org_Auto,orgName,isnull(targetNum,0) targetNum
	into #C
    from (
    select @Mode Mode,case when @Mode = 1 then a4.Org_Auto else f.Org_Auto end Org_Auto
    ,case when @Mode = 1 then a4.DepName else f.DepName end orgName
    ,convert(int,round(sum(p_Count * 3.33),0)) targetPaperNum,sum(CustNum) proPaperNum,sum(p_Count) targetNum,sum(p_RealCount) realNum,sum(p_Count * @Amt) targetVolume,sum(RealAmt) realVolume

    from (
    select a3.Org_Auto,a3.DepName,p_Count,CustNum,count(e.order_auto) p_RealCount,sum(e.MM*e.MAmt) RealAmt
    from (
    select a2.Org_Auto,a2.DepName,sum(a2.p_Count)p_Count,sum(CustNum) CustNum
    from (
    select a1.Org_Auto,a1.DepName,a1.Sales_Auto,a1.p_Count ,count(TradeItem_Auto) CustNum
    from(
    select distinct a.Org_Auto,b.DepName
    ,b.user_auto Sales_Auto,c.p_Count,d.TradeItem_Auto
    from @Org a
    left join v_Emp b on b.Org_Auto = a.Org_Auto
    left join Performance c on c.Sales_Auto = b.User_Auto and P_Year = year(@StartDT) and P_Month =month(@StartDT)
    left join orders d on d.Sales_Auto = b.User_Auto and d.OrderStatus = 20 and d.PostType = 4 and convert(varchar(10),d.AppDate,120) between @StartDT and @EndDT
    ) a1
    group by a1.Org_Auto,a1.DepName,a1.Sales_Auto,a1.p_Count
    )a2
    group by a2.Org_Auto,a2.DepName
    )a3
    left join [order] e on e.YJOrg = a3.Org_Auto and e.YJCDT between @StartDT and @EndDT
    group by a3.Org_Auto,a3.DepName,p_Count,CustNum
    ) a4
    left join AspNet.dbo.Org g on g.Org_Auto = a4.Org_Auto
    left join AspNet.dbo.Org f on f.Org_Auto = g.UpUnit
    group by case when @Mode = 1 then a4.Org_Auto else f.Org_Auto end,case when @Mode = 1 then a4.DepName else f.DepName end
    ) a5
    end

--当月目标
select
sum(case when Mode = 2 then targetNum else 0 end)*194770*0.25 newExs,
sum(case when Mode = 2 then targetNum else 0 end)*194770 - sum(case when Mode = 2 then targetNum else 0 end)*194770*0.25*2 retain,
sum(case when Mode = 2 then targetNum else 0 end)*194770*0.25 introduce
into #D
from #C

select newExs,retain,introduce,(newExs+retain+introduce) totalNumAmt from #D

drop table #C
drop table #D
    drop table #Roles

  </select>
  <select id="selectThisMonReal" resultMap="queryThisMonGoal">
    declare
    @inc int,
    @type int,
    @year varchar(10),
    @month varchar(10),
    @flag int,
    @customer varchar(100),
    @StartDT varchar(50),
    @EndDT varchar(50),
    @typeQuery int
    set @inc = #{param.inc}
    set	@type = #{param.type}
    set	@year = #{param.year}
    set	@month = #{param.month}
    set	@flag = #{param.flag}
    set	@customer = #{param.customer}
    set @StartDT = #{param.startDate}
    set @EndDT = #{param.endDate}
    set @typeQuery = #{param.typeQuery}
    BEGIN
    declare @order table(
    order_auto bigint,
    orders_auto bigint
    )

    insert into @order
    select distinct a.Order_Auto,a.orders_auto
    from [order] a  (nolock)
    inner join tradeitem c  (nolock) on a.tradeitem_auto=c.tradeitem_auto
    left join Credit_Order f (nolock)  on a.Orders_Auto=f.Orders_Auto
    inner join CreditMainInfo g (nolock)  on f.CreditMain_Auto=g.CreditMain_Auto and g.CreditStatus>=10
    left join BookCar i  (nolock) on g.CreditMain_Auto=i.CreditMain_Auto
    left join BookCarNote k  (nolock) on k.CreditMain_Auto=g.CreditMain_Auto and k.Status=1
    where  a.OrderType in(1,5,6) and (a.Inc_Auto=@inc or @inc=0) and
    (
    (@customer!='' and c.FName like '%'+@customer+'%' and (a.YJCDT is null or a.JCDT is null)) or
    ((@customer ='') and (
    (
    (@flag=0 and
    ((@type=1 and
    (
    (isnull(a.DptAmt,0)>0 and ( ((@month between 2 and 11) and ((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month-1 and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )>=21) or (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )&lt;=20)))
    or (@month=1 and DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )&lt;=20)
    or (@month=12 and ((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month-1 and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )>=21) or (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month))) ) and DATEPART(YYYY,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@year)
    or
    (isnull(a.DptAmt,0)=0 and ( ((@month between 2 and 11) and ((DATEPART(MM,i.EndDT)=@month-1 and DATEPART(DD,i.EndDT)>=21) or (DATEPART(MM,i.EndDT)=@month and DATEPART(DD,i.EndDT)&lt;=20)))
    or (@month=1 and DATEPART(MM,i.EndDT)=@month and DATEPART(DD,i.EndDT)&lt;=20)
    or (@month=12 and ((DATEPART(MM,i.EndDT)=@month-1 and DATEPART(DD,i.EndDT)>=21) or (DATEPART(MM,i.EndDT)=@month))) ) and DATEPART(YYYY,i.EndDT)=@year)
    )
    )
    or (@type=2 and ( ((@month between 2 and 11) and ((DATEPART(MM,a.JCDT)=@month-1 and DATEPART(DD,a.JCDT)>=21) or (DATEPART(MM,a.JCDT)=@month and DATEPART(DD,a.JCDT)&lt;=20)) )
    or (@month=1 and DATEPART(MM,a.JCDT)=@month and DATEPART(DD,a.JCDT)&lt;=20)
    or (@month=12 and ((DATEPART(MM,a.JCDT)=@month-1 and DATEPART(DD,a.JCDT)>=21) or (DATEPART(MM,a.JCDT)=@month))) )  and DATEPART(YYYY,a.JCDT)=@year)
    or (@type=3 and ( ((@month between 2 and 11) and ((DATEPART(MM,a.BoundDT)=@month-1 and DATEPART(DD,a.BoundDT)>=21) or (DATEPART(MM,a.BoundDT)=@month and DATEPART(DD,a.BoundDT)&lt;=20)) )
    or (@month=1 and DATEPART(MM,a.BoundDT)=@month and DATEPART(DD,a.BoundDT)&lt;=20)
    or (@month=12 and ((DATEPART(MM,a.BoundDT)=@month-1 and DATEPART(DD,a.BoundDT)>=21) or (DATEPART(MM,a.BoundDT)=@month))) )  and DATEPART(YYYY,a.BoundDT)=@year)
    or (@type=4 and ( ((@month between 2 and 11) and ((DATEPART(MM,a.YJCDT)=@month-1 and DATEPART(DD,a.YJCDT)>=21) or (DATEPART(MM,a.YJCDT)=@month and DATEPART(DD,a.YJCDT)&lt;=20)) )
    or (@month=1 and DATEPART(MM,a.YJCDT)=@month and DATEPART(DD,a.YJCDT)&lt;=20)
    or (@month=12 and ((DATEPART(MM,a.YJCDT)=@month-1 and DATEPART(DD,a.YJCDT)>=21) or (DATEPART(MM,a.YJCDT)=@month))) )  and DATEPART(YYYY,a.YJCDT)=@year)
    or (
    @type=5 and isnull(case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end,'') &lt;>'' and (
    (( ((@month between 2 and 11) and ((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month-1 and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )>=21) or (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )&lt;=20)))
    or (@month=1 and DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )&lt;=20)
    or (@month=12 and ((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month-1 and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )>=21) or (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month))) ) and DATEPART(YYYY,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@year
    )
    or
    (( ((@month between 2 and 11) and ((DATEPART(MM,a.JCDT)=@month-1 and DATEPART(DD,a.JCDT)>=21) or (DATEPART(MM,a.JCDT)=@month and DATEPART(DD,a.JCDT)&lt;=20)) )
    or (@month=1 and DATEPART(MM,a.JCDT)=@month and DATEPART(DD,a.JCDT)&lt;=20)
    or (@month=12 and ((DATEPART(MM,a.JCDT)=@month-1 and DATEPART(DD,a.JCDT)>=21) or (DATEPART(MM,a.JCDT)=@month))) )  and DATEPART(YYYY,a.JCDT)=@year
    )
    or (a.JCDT is null )
    )
    )
    )
    )
    or (@flag=1 and
    (
    (@type=1 and (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(YYYY,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@year))
    or (@type=2 and (DATEPART(MM,a.JCDT)=@month and DATEPART(YYYY,a.JCDT)=@year))
    or (@type=3 and (DATEPART(MM,a.BoundDT)=@month and DATEPART(YYYY,a.BoundDT)=@year))
    or (@type=4 and (DATEPART(MM,a.YJCDT)=@month and DATEPART(YYYY,a.YJCDT)=@year))
    or (
    @type=5 and isnull(case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end,'') &lt;>'' and (
    ((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(YYYY,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@year))
    or
    ((DATEPART(MM,a.JCDT)=@month and DATEPART(YYYY,a.JCDT)=@year))
    or (a.JCDT is null)
    )
    )
    ))
    )
    or (case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end &lt;'2013/11/21' and a.Order_Auto in(6064,4325,4326,6067,6061,5963,6065,6017,6068,5984,5993,5962,6047,5981,6002,5870,6013,6014,6071,6042)
    and (a.JCDT='' or a.JCDT is null) and @type&lt;>4
    )
    ))
    )

    select a.Order_Auto,sum(b.InCome + b.InComePre) InCome
    into #G
    from @Order a
    left join OrderRent b on b.Order_Auto = a.Order_Auto
    group by a.Order_Auto

    select a.Order_Auto
    ,sum(case b.CountMode when 0 then Amt when 12 then isnull(Amt*1.0/12 * c.MM,0) when 1 then isnull(case when b.type_auto = 3 then Amt*1.0/12 else Amt end,0) * c.MM end) BudgetAmt
    into #D
    from @Order a
    left join OrderBudget b on b.Order_Auto = a.Order_Auto and b.type_auto &lt;> 0
    left join [order] c on c.Order_Auto = a.Order_Auto
    group by a.Order_Auto

    select b1.DepName depName,b.FNAme fName,a.OrderNo, c.TradeItem_Auto,c.FName comFName,case when q.identype = 1 then '是' else '' end	idenType,h.SName sName
    ,case when a.status=30 then '正常' when a.status=40 then '解约' when a.status=10 then '送件' else '暂存' end statusName
    ,d.MakNo makNo,dbo.f_GetItemName(226,d.Category) category,dbo.f_GetItemName(313,a.CustSource) custSource,dbo.f_GetItemName(314,a.RentType) rentType,L.FactoryBrandName factoryBrandName,m.BrandName brandName,e.ClasenName clasenName
    ,d.CarColor carColor,n.FName sellerFName,a.MAmt ,a.MAmt*a.MM totalAmt,d.MakDT makDT
    ,a.ListPrice ,a.GetPrice ,a.DisPrice ,Convert(decimal(16,2), a.DisPrice /case when a.ListPrice > 0 then a.ListPrice else 1 end * 100) disPriceTax,a.Accessary ,j.PushMoney pushMoney,case when a.RentType = 2 and isnull(j.OverAmt_Y,0) > 0 then j.OverAmt else a.OverAmt end salvage,a.DptAmt ,a.CarMtnAmt ,case when j.OrderType = 8 then a.CarCost-a.StampTax else a.ListPrice-a.DisPrice-case when a.RentType = 2 and isnull(j.OverAmt_Y,0) > 0 then j.OverAmt else a.OverAmt end end loanAmount
    ,a.StartDT ,a.EndDT ,a.MM ,dbo.f_GetItemName(115,g.Creditlevle) creditLevel
    ,a.Order_Auto ,g.CreditMain_Auto,g.ContractNo contractNo
    ,ISNULL(a.JCDT,t.deliveryDT) forDT
    ,dbo.f_GetItemName(1001,g.PayType) payType
    ,case j.CarSource when 1 then '新车' when 2 then '调度中心' when 3  then '原车续租' when 4 then '外购二手车' end carSource,a.RentRate
    , a.finalrate , a.rentamt ,a.BonusRate
    ,s.ItemName businessType
    ,s1.ItemName businessOrdersType
    ,isnull(o.RealAmt,0) realAmt,isnull(p.RealAmt,0) accRealAmt,a.YJCDT ,dbo.f_GetItemName(225,d.UseType)  useType,case when j.Onetime = 1 then '是' else '' end onetime
    ,isnull(r.Project_Name,'') projectName
    ,case when u.ItemName like '%货车%' then '货车' else case when j.Onetime = 1 then '一次性' else v.ItemName end end trucks
    ,w.ItemName comType
    ,x.InsureMM insureMM
    ,x.InsureAmt insureAmt
    ,a.CarTax carTax
    ,isnull(a1.InCome,0) inCome
    ,j.CarCost carCost
    ,isnull(a2.BudgetAmt,0)  budgetAmt
    into #E
    from @order aa
    left join [order] a (nolock) on a.Order_Auto = aa.order_auto
    inner join v_emp b  (nolock) on a.YJSales=b.User_Auto
    inner join AspNet.dbo.Org b1  (nolock) on b1.Org_Auto = a.YJOrg
    inner join tradeitem c  (nolock) on a.tradeitem_auto=c.tradeitem_auto
    inner join Carbase d  (nolock) on a.Carbase_auto=d.Carbase_auto
    inner join Clasen e  (nolock) on a.clasen_auto=e.clasen_auto
    inner join Brand m  (nolock) on a.Brand_Auto=m.Brand_Auto
    inner join Inc h  (nolock) on a.Inc_Auto=h.Inc_Auto
    left join FactoryBrand l  (nolock) on l.FactoryBrand_Auto=d.FactoryBrand_Auto
    left join Credit_Order f  (nolock) on a.Orders_Auto=f.Orders_Auto
    inner join CreditMainInfo g  (nolock) on f.CreditMain_Auto=g.CreditMain_Auto and g.CreditStatus>=10
    left join Orders j  (nolock) on a.Orders_Auto=j.Orders_Auto
    left join TradeItem n  (nolock) on n.TradeItem_Auto = d.supplier
    left join dpn o  (nolock) on o.Order_Auto = a.Order_Auto and o.DPN_Type = 2
    left join dpn p  (nolock) on p.Order_Auto = a.Order_Auto and p.DPN_Type = 3
    left join Customer q  (nolock) on q.TradeItem_Auto = c.TradeItem_Auto
    left join Orders_Project r (nolock)  on r.Project_Auto = j.Project_Auto
    left join ItemCode s (nolock)  on s.ItemType = 326 and s.Num = a.OrderType
    left join ItemCode s1 (nolock) on s1.ItemType = 326 and s1.Num = j.OrderType
    LEFT JOIN DEliverycar t  (nolock) on t.Order_auto=a.Order_Auto AND t.[Status]=1 AND t.ReturnVisit_Auto>0
    left join ItemCode u  (nolock) on u.ItemType = 410 and u.Num = d.InsurePercnt
    left join ItemCode v  (nolock) on v.ItemType = 503 and v.Num = j.CarSource
    left join ItemCode w  (nolock) on w.ItemType = 111 and w.Num = q.IncType
    left join (	select k1.Order_Auto,
    sum(case when k3.InsureType = 2 then 1 else 0 end * 12  - case when k2.MM%12 > 0 and k3.InsureType = 2 and k3.InsureYear = k2.MM/12 then 12 - k2.MM%12 else 0 end) InsureMM  ,
    sum(case when k3.InsureType = 2 and k3.InsureYear = 1 then k3.InsureRealAmt else 0 end) InsureAmt
    from @Order k1
    left join orders k2 on k2.Orders_Auto = k1.Orders_Auto
    left join OrdersInsureList k3 on k3.Orders_Auto = k2.Orders_Auto and k3.InsureType = 2
    group by k1.Order_Auto,k2.MM,k2.IsCustomerCare)x on x.order_auto = a.Order_Auto
    left join #G a1 on a1.Order_Auto = a.Order_Auto
    left join #D a2 on a2.Order_Auto = a.Order_Auto
    Order by b1.DepName,b.FNAme

    if @typeQuery = 1
    begin
    select
    sum(case when carSource = '新车'and depName like '%华东%' then totalAmt else 0 end) eastNewCar,
    sum(case when carSource != '新车'and depName like '%华东%' then totalAmt else 0 end) eastOldCar,
    sum(case when carSource = '新车'and depName like '%华南%' then totalAmt else 0 end) southNewCar,
    sum(case when carSource != '新车'and depName like '%华南%' then totalAmt else 0 end) southOldCar,
    YJCDT
    into #F
    from #E
    group by YJCDT

    select
    sum(eastNewCar) eastNewCar,
    sum(eastOldCar) eastOldCar,
    sum(southNewCar) southNewCar,
    sum(southOldCar) southOldCar,
    sum(eastNewCar+eastOldCar+southNewCar+southOldCar) totalNumAmt
    from #F
    where YJCDT between @StartDT and @EndDT
    drop table #F

    end

    else if @typeQuery = 2
    begin
    declare
    @eastNewCar decimal(18,2),
    @eastOldCar decimal(18,2),
    @southNewCar decimal(18,2),
    @southOldCar decimal(18,2),
    @totalNumAmt decimal(18,2)

    select @eastNewCar=count(carSource)  from #E where carSource = '新车'and depName like '%华东%' and YJCDT between @StartDT and @EndDT
    select @eastOldCar=count(carSource)  from #E where carSource != '新车'and depName like '%华东%' and YJCDT between @StartDT and @EndDT
    select @southNewCar=count(carSource)  from #E where carSource = '新车'and depName like '%华南%' and YJCDT between @StartDT and @EndDT
    select @southOldCar=count(carSource)  from #E where carSource != '新车'and depName like '%华南%' and YJCDT between @StartDT and @EndDT
    select @totalNumAmt=count(carSource)  from #E where YJCDT between @StartDT and @EndDT
    select @eastNewCar eastNewCar,@eastOldCar eastOldCar,@southNewCar southNewCar,@southOldCar southOldCar,@totalNumAmt totalNumAmt
    end

    else if @typeQuery = 3
    begin
    select
    sum(case when custSource like '%新拓%' then totalAmt else 0 end) newExs,
    sum(case when custSource like '%保有%' then totalAmt else 0 end) retain,
    sum(case when custSource like '%介绍%' then totalAmt else 0 end) introduce,
    YJCDT
    into #H
    from #E
    group by YJCDT

    select sum(newExs) newExs,sum(retain) retain,sum(introduce) introduce,sum(newExs+retain+introduce) totalNumAmt from #H where YJCDT between @StartDT and @EndDT
    drop table #H
    end

    drop table #E
    drop table #G
    drop table #D
    end
  </select>

  <resultMap id="queryCarSourceRent" extends="BaseResultMap" type="com.funtl.myshop.plus.provider.domain.CarSourceRent">
    <result column="eastNewCar" jdbcType="DECIMAL" property="eastNewCar" />
    <result column="eastOldCar" jdbcType="DECIMAL" property="eastOldCar" />
    <result column="southNewCar" jdbcType="DECIMAL" property="southNewCar" />
    <result column="southOldCar" jdbcType="DECIMAL" property="southOldCar" />
    <result column="totalNumAmt" jdbcType="DECIMAL" property="totalNumAmt" />
  </resultMap>
  <select id="selectCarSourceRent" resultMap="queryCarSourceRent">
    declare
    @inc int,
    @type int,
    @year varchar(10),
    @month varchar(10),
    @flag int,
    @customer varchar(100),
    @StartDT varchar(50),
    @EndDT varchar(50),
    @typeQuery int
    set @inc = #{param.inc}
    set	@type = #{param.type}
    set	@year = #{param.year}
    set	@month = #{param.month}
    set	@flag = #{param.flag}
    set	@customer = #{param.customer}
    set @StartDT = #{param.startDate}
    set @EndDT = #{param.endDate}
    set @typeQuery = #{param.typeQuery}
    BEGIN
    declare @order table(
    order_auto bigint,
    orders_auto bigint
    )

    insert into @order
    select distinct a.Order_Auto,a.orders_auto
    from [order] a  (nolock)
    inner join tradeitem c  (nolock) on a.tradeitem_auto=c.tradeitem_auto
    left join Credit_Order f (nolock)  on a.Orders_Auto=f.Orders_Auto
    inner join CreditMainInfo g (nolock)  on f.CreditMain_Auto=g.CreditMain_Auto and g.CreditStatus>=10
    left join BookCar i  (nolock) on g.CreditMain_Auto=i.CreditMain_Auto
    left join BookCarNote k  (nolock) on k.CreditMain_Auto=g.CreditMain_Auto and k.Status=1
    where  a.OrderType in(1,5,6) and (a.Inc_Auto=@inc or @inc=0) and
    (
    (@customer!='' and c.FName like '%'+@customer+'%' and (a.YJCDT is null or a.JCDT is null)) or
    ((@customer ='') and (
    (
    (@flag=0 and
    ((@type=1 and
    (
    (isnull(a.DptAmt,0)>0 and ( ((@month between 2 and 11) and ((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month-1 and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )>=21) or (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )&lt;=20)))
    or (@month=1 and DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )&lt;=20)
    or (@month=12 and ((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month-1 and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )>=21) or (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month))) ) and DATEPART(YYYY,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@year)
    or
    (isnull(a.DptAmt,0)=0 and ( ((@month between 2 and 11) and ((DATEPART(MM,i.EndDT)=@month-1 and DATEPART(DD,i.EndDT)>=21) or (DATEPART(MM,i.EndDT)=@month and DATEPART(DD,i.EndDT)&lt;=20)))
    or (@month=1 and DATEPART(MM,i.EndDT)=@month and DATEPART(DD,i.EndDT)&lt;=20)
    or (@month=12 and ((DATEPART(MM,i.EndDT)=@month-1 and DATEPART(DD,i.EndDT)>=21) or (DATEPART(MM,i.EndDT)=@month))) ) and DATEPART(YYYY,i.EndDT)=@year)
    )
    )
    or (@type=2 and ( ((@month between 2 and 11) and ((DATEPART(MM,a.JCDT)=@month-1 and DATEPART(DD,a.JCDT)>=21) or (DATEPART(MM,a.JCDT)=@month and DATEPART(DD,a.JCDT)&lt;=20)) )
    or (@month=1 and DATEPART(MM,a.JCDT)=@month and DATEPART(DD,a.JCDT)&lt;=20)
    or (@month=12 and ((DATEPART(MM,a.JCDT)=@month-1 and DATEPART(DD,a.JCDT)>=21) or (DATEPART(MM,a.JCDT)=@month))) )  and DATEPART(YYYY,a.JCDT)=@year)
    or (@type=3 and ( ((@month between 2 and 11) and ((DATEPART(MM,a.BoundDT)=@month-1 and DATEPART(DD,a.BoundDT)>=21) or (DATEPART(MM,a.BoundDT)=@month and DATEPART(DD,a.BoundDT)&lt;=20)) )
    or (@month=1 and DATEPART(MM,a.BoundDT)=@month and DATEPART(DD,a.BoundDT)&lt;=20)
    or (@month=12 and ((DATEPART(MM,a.BoundDT)=@month-1 and DATEPART(DD,a.BoundDT)>=21) or (DATEPART(MM,a.BoundDT)=@month))) )  and DATEPART(YYYY,a.BoundDT)=@year)
    or (@type=4 and ( ((@month between 2 and 11) and ((DATEPART(MM,a.YJCDT)=@month-1 and DATEPART(DD,a.YJCDT)>=21) or (DATEPART(MM,a.YJCDT)=@month and DATEPART(DD,a.YJCDT)&lt;=20)) )
    or (@month=1 and DATEPART(MM,a.YJCDT)=@month and DATEPART(DD,a.YJCDT)&lt;=20)
    or (@month=12 and ((DATEPART(MM,a.YJCDT)=@month-1 and DATEPART(DD,a.YJCDT)>=21) or (DATEPART(MM,a.YJCDT)=@month))) )  and DATEPART(YYYY,a.YJCDT)=@year)
    or (
    @type=5 and isnull(case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end,'') &lt;>'' and (
    (( ((@month between 2 and 11) and ((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month-1 and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )>=21) or (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )&lt;=20)))
    or (@month=1 and DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )&lt;=20)
    or (@month=12 and ((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month-1 and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )>=21) or (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month))) ) and DATEPART(YYYY,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@year
    )
    or
    (( ((@month between 2 and 11) and ((DATEPART(MM,a.JCDT)=@month-1 and DATEPART(DD,a.JCDT)>=21) or (DATEPART(MM,a.JCDT)=@month and DATEPART(DD,a.JCDT)&lt;=20)) )
    or (@month=1 and DATEPART(MM,a.JCDT)=@month and DATEPART(DD,a.JCDT)&lt;=20)
    or (@month=12 and ((DATEPART(MM,a.JCDT)=@month-1 and DATEPART(DD,a.JCDT)>=21) or (DATEPART(MM,a.JCDT)=@month))) )  and DATEPART(YYYY,a.JCDT)=@year
    )
    or (a.JCDT is null )
    )
    )
    )
    )
    or (@flag=1 and
    (
    (@type=1 and (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(YYYY,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@year))
    or (@type=2 and (DATEPART(MM,a.JCDT)=@month and DATEPART(YYYY,a.JCDT)=@year))
    or (@type=3 and (DATEPART(MM,a.BoundDT)=@month and DATEPART(YYYY,a.BoundDT)=@year))
    or (@type=4 and (DATEPART(MM,a.YJCDT)=@month and DATEPART(YYYY,a.YJCDT)=@year))
    or (
    @type=5 and isnull(case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end,'') &lt;>'' and (
    ((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(YYYY,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@year))
    or
    ((DATEPART(MM,a.JCDT)=@month and DATEPART(YYYY,a.JCDT)=@year))
    or (a.JCDT is null)
    )
    )
    ))
    )
    or (case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end &lt;'2013/11/21' and a.Order_Auto in(6064,4325,4326,6067,6061,5963,6065,6017,6068,5984,5993,5962,6047,5981,6002,5870,6013,6014,6071,6042)
    and (a.JCDT='' or a.JCDT is null) and @type&lt;>4
    )
    ))
    )

    select a.Order_Auto,sum(b.InCome + b.InComePre) InCome
    into #G
    from @Order a
    left join OrderRent b on b.Order_Auto = a.Order_Auto
    group by a.Order_Auto

    select a.Order_Auto
    ,sum(case b.CountMode when 0 then Amt when 12 then isnull(Amt*1.0/12 * c.MM,0) when 1 then isnull(case when b.type_auto = 3 then Amt*1.0/12 else Amt end,0) * c.MM end) BudgetAmt
    into #D
    from @Order a
    left join OrderBudget b on b.Order_Auto = a.Order_Auto and b.type_auto &lt;> 0
    left join [order] c on c.Order_Auto = a.Order_Auto
    group by a.Order_Auto

    select b1.DepName depName,b.FNAme fName,a.OrderNo, c.TradeItem_Auto,c.FName comFName,case when q.identype = 1 then '是' else '' end	idenType,h.SName sName
    ,case when a.status=30 then '正常' when a.status=40 then '解约' when a.status=10 then '送件' else '暂存' end statusName
    ,d.MakNo makNo,dbo.f_GetItemName(226,d.Category) category,dbo.f_GetItemName(313,a.CustSource) custSource,dbo.f_GetItemName(314,a.RentType) rentType,L.FactoryBrandName factoryBrandName,m.BrandName brandName,e.ClasenName clasenName
    ,d.CarColor carColor,n.FName sellerFName,a.MAmt ,a.MAmt*a.MM totalAmt,d.MakDT makDT
    ,a.ListPrice ,a.GetPrice ,a.DisPrice ,Convert(decimal(16,2), a.DisPrice /case when a.ListPrice > 0 then a.ListPrice else 1 end * 100) disPriceTax,a.Accessary ,j.PushMoney pushMoney,case when a.RentType = 2 and isnull(j.OverAmt_Y,0) > 0 then j.OverAmt else a.OverAmt end salvage,a.DptAmt ,a.CarMtnAmt ,case when j.OrderType = 8 then a.CarCost-a.StampTax else a.ListPrice-a.DisPrice-case when a.RentType = 2 and isnull(j.OverAmt_Y,0) > 0 then j.OverAmt else a.OverAmt end end loanAmount
    ,a.StartDT ,a.EndDT ,a.MM ,dbo.f_GetItemName(115,g.Creditlevle) creditLevel
    ,a.Order_Auto ,g.CreditMain_Auto,g.ContractNo contractNo
    ,ISNULL(a.JCDT,t.deliveryDT) forDT
    ,dbo.f_GetItemName(1001,g.PayType) payType
    ,case j.CarSource when 1 then '新车' when 2 then '调度中心' when 3  then '原车续租' when 4 then '外购二手车' end carSource,a.RentRate
    , a.finalrate , a.rentamt ,a.BonusRate
    ,s.ItemName businessType
    ,s1.ItemName businessOrdersType
    ,isnull(o.RealAmt,0) realAmt,isnull(p.RealAmt,0) accRealAmt,a.YJCDT ,dbo.f_GetItemName(225,d.UseType)  useType,case when j.Onetime = 1 then '是' else '' end onetime
    ,isnull(r.Project_Name,'') projectName
    ,case when u.ItemName like '%货车%' then '货车' else case when j.Onetime = 1 then '一次性' else v.ItemName end end trucks
    ,w.ItemName comType
    ,x.InsureMM insureMM
    ,x.InsureAmt insureAmt
    ,a.CarTax carTax
    ,isnull(a1.InCome,0) inCome
    ,j.CarCost carCost
    ,isnull(a2.BudgetAmt,0)  budgetAmt
    into #E
    from @order aa
    left join [order] a (nolock) on a.Order_Auto = aa.order_auto
    inner join v_emp b  (nolock) on a.YJSales=b.User_Auto
    inner join AspNet.dbo.Org b1  (nolock) on b1.Org_Auto = a.YJOrg
    inner join tradeitem c  (nolock) on a.tradeitem_auto=c.tradeitem_auto
    inner join Carbase d  (nolock) on a.Carbase_auto=d.Carbase_auto
    inner join Clasen e  (nolock) on a.clasen_auto=e.clasen_auto
    inner join Brand m  (nolock) on a.Brand_Auto=m.Brand_Auto
    inner join Inc h  (nolock) on a.Inc_Auto=h.Inc_Auto
    left join FactoryBrand l  (nolock) on l.FactoryBrand_Auto=d.FactoryBrand_Auto
    left join Credit_Order f  (nolock) on a.Orders_Auto=f.Orders_Auto
    inner join CreditMainInfo g  (nolock) on f.CreditMain_Auto=g.CreditMain_Auto and g.CreditStatus>=10
    left join Orders j  (nolock) on a.Orders_Auto=j.Orders_Auto
    left join TradeItem n  (nolock) on n.TradeItem_Auto = d.supplier
    left join dpn o  (nolock) on o.Order_Auto = a.Order_Auto and o.DPN_Type = 2
    left join dpn p  (nolock) on p.Order_Auto = a.Order_Auto and p.DPN_Type = 3
    left join Customer q  (nolock) on q.TradeItem_Auto = c.TradeItem_Auto
    left join Orders_Project r (nolock)  on r.Project_Auto = j.Project_Auto
    left join ItemCode s (nolock)  on s.ItemType = 326 and s.Num = a.OrderType
    left join ItemCode s1 (nolock) on s1.ItemType = 326 and s1.Num = j.OrderType
    LEFT JOIN DEliverycar t  (nolock) on t.Order_auto=a.Order_Auto AND t.[Status]=1 AND t.ReturnVisit_Auto>0
    left join ItemCode u  (nolock) on u.ItemType = 410 and u.Num = d.InsurePercnt
    left join ItemCode v  (nolock) on v.ItemType = 503 and v.Num = j.CarSource
    left join ItemCode w  (nolock) on w.ItemType = 111 and w.Num = q.IncType
    left join (	select k1.Order_Auto,
    sum(case when k3.InsureType = 2 then 1 else 0 end * 12  - case when k2.MM%12 > 0 and k3.InsureType = 2 and k3.InsureYear = k2.MM/12 then 12 - k2.MM%12 else 0 end) InsureMM  ,
    sum(case when k3.InsureType = 2 and k3.InsureYear = 1 then k3.InsureRealAmt else 0 end) InsureAmt
    from @Order k1
    left join orders k2 on k2.Orders_Auto = k1.Orders_Auto
    left join OrdersInsureList k3 on k3.Orders_Auto = k2.Orders_Auto and k3.InsureType = 2
    group by k1.Order_Auto,k2.MM,k2.IsCustomerCare)x on x.order_auto = a.Order_Auto
    left join #G a1 on a1.Order_Auto = a.Order_Auto
    left join #D a2 on a2.Order_Auto = a.Order_Auto
    Order by b1.DepName,b.FNAme

    if @typeQuery = 1
    begin
    select
    sum(case when carSource = '新车'and depName like '%华东%' then totalAmt else 0 end) eastNewCar,
    sum(case when carSource != '新车'and depName like '%华东%' then totalAmt else 0 end) eastOldCar,
    sum(case when carSource = '新车'and depName like '%华南%' then totalAmt else 0 end) southNewCar,
    sum(case when carSource != '新车'and depName like '%华南%' then totalAmt else 0 end) southOldCar,
    YJCDT
    into #F
    from #E
    group by YJCDT

    select
    sum(eastNewCar) eastNewCar,
    sum(eastOldCar) eastOldCar,
    sum(southNewCar) southNewCar,
    sum(southOldCar) southOldCar,
    sum(eastNewCar+eastOldCar+southNewCar+southOldCar) totalNumAmt
    from #F
    where YJCDT between @StartDT and @EndDT
    drop table #F

    end

    else if @typeQuery = 2
    begin
    declare
    @eastNewCar decimal(18,2),
    @eastOldCar decimal(18,2),
    @southNewCar decimal(18,2),
    @southOldCar decimal(18,2),
    @totalNumAmt decimal(18,2)

    select @eastNewCar=count(carSource)  from #E where carSource = '新车'and depName like '%华东%' and YJCDT between @StartDT and @EndDT
    select @eastOldCar=count(carSource)  from #E where carSource != '新车'and depName like '%华东%' and YJCDT between @StartDT and @EndDT
    select @southNewCar=count(carSource)  from #E where carSource = '新车'and depName like '%华南%' and YJCDT between @StartDT and @EndDT
    select @southOldCar=count(carSource)  from #E where carSource != '新车'and depName like '%华南%' and YJCDT between @StartDT and @EndDT
    select @totalNumAmt=count(carSource)  from #E where YJCDT between @StartDT and @EndDT
    select @eastNewCar eastNewCar,@eastOldCar eastOldCar,@southNewCar southNewCar,@southOldCar southOldCar,@totalNumAmt totalNumAmt
    end

    else if @typeQuery = 3
    begin
    select
    sum(case when custSource like '%新拓%' then totalAmt else 0 end) newExs,
    sum(case when custSource like '%保有%' then totalAmt else 0 end) retain,
    sum(case when custSource like '%介绍%' then totalAmt else 0 end) introduce,
    YJCDT
    into #H
    from #E
    group by YJCDT

    select sum(newExs) newExs,sum(retain) retain,sum(introduce) introduce,sum(newExs+retain+introduce) totalNumAmt from #H where YJCDT between @StartDT and @EndDT
    drop table #H
    end

    drop table #E
    drop table #G
    drop table #D
    end
  </select>
  <resultMap id="queryCustomerNum" type="com.funtl.myshop.plus.provider.domain.CustomerNum">
    <result column="createNum" jdbcType="INTEGER" property="createNum" />
    <result column="endNum" jdbcType="INTEGER" property="endNum" />
    <result column="beforeEndNum" jdbcType="INTEGER" property="beforeEndNum" />
  </resultMap>
    <select id="selectCustomerNum" resultMap="queryCustomerNum">
        ----S_Credit_ORder
declare
@Type int = #{param.type},
@YY int=#{param.yy},
@MM int=#{param.mm},
@Order_Type int=#{param.orderType},
@Inc_Auto bigint=#{param.incAuto},
@pageSize    int=#{param.pageSize},
@page        int=#{param.page},
@StartDT datetime = #{param.startDate},
@EndDT datetime = #{param.endDate}

	declare @Day_T nvarchar(40),@YY_T int,@MM_T int
	declare @Order_Q table(Order_Auto nvarchar(10),RentType int,OrderType int,StartDT nvarchar(20),EndDT nvarchar(20),ResDT nvarchar(20)
	,Status int,Inc_Auto bigint,Carbase_Auto bigint,TradeItem_Auto bigint,Sales_Auto bigint,MAmt int,CarSource int,CarDT nvarchar(10),MakDT nvarchar(10))
	select @YY_T=DATEPART(YYYY,getdate())
	select @MM_T=DATEPART(MM,getdate())
   declare @D_Q nvarchar(40),@D_T nvarchar(40),@Day_F nvarchar(40)
   select @D_Q=convert(nvarchar(40),convert(datetime,convert(char(4),@YY)+'/'+convert(char(2),@MM)+'/01'),111)
   select @D_T=convert(nvarchar(40),convert(datetime,convert(char(4),@YY_T)+'/'+convert(char(2),@MM_T)+'/01'),111)
   if(@D_Q>=@D_T)
   begin
      select @Day_T=convert(nvarchar(20),DATEADD(dd,-1,DATEADD(MM,1,@D_T)),111)
	  select @Day_F=convert(nvarchar(20),@D_T,111)
	  select @YY=DATEPART(YY,@Day_T)
	  select @MM=DATEPART(MM,@Day_T)
   end
   if(@D_Q&lt;@D_T)
   begin
      select @Day_T=convert(nvarchar(20),DATEADD(dd,-1,DATEADD(MM,1,@D_Q)),111)
	  select @Day_F=convert(nvarchar(20),@D_Q,111)
   end
   --select Day_T=@Day_T
    insert into @Order_Q(Order_Auto,RentType,OrderType,StartDT,EndDT,ResDT,Status,Inc_Auto,Carbase_Auto,TradeItem_Auto,Sales_Auto,MAmt ,CarSource ,CarDT ,MakDT)
	select a.Order_Auto,a.RentType,isnull(b.OrderType,a.OrderType) OrderType,StartDT=convert(nvarchar(20),a.StartDT,111),EndDT=convert(nvarchar(20),a.EndDT,111)
	,ResDT=convert(nvarchar(20),a.ResDT,111),a.Status,a.Inc_Auto,a.CarBase_Auto,a.TradeItem_Auto,a.Sales_Auto,a.MAmt,b.CarSource,convert(nvarchar(10),c.CarDT,111),convert(nvarchar(10),c.MakDT,111)
	from [order] a
	left join orders b on isnull(a.orders_auto,0) > 0 and b.orders_auto = a.orders_auto
	left join CarBase c on c.CarBase_Auto = a.CarBase_Auto
	where a.OrderType!=3---不含月租
	and
    (
      (a.[Status]=30  and ((a.EndDT&lt;=@Day_T) or (a.EndDT>@Day_T and a.StartDT&lt;=@Day_T))) or
	  (a.[Status]=40 and a.ResDT>@Day_T and (
	   (convert(nvarchar(20),a.StartDT,111)&lt;@Day_F and convert(nvarchar(20),a.EndDT,111)>@Day_T)
	   or (convert(nvarchar(20),a.StartDT,111)&lt;@Day_F and convert(nvarchar(20),a.EndDT,111) between @Day_F and @Day_T) or
	   (convert(nvarchar(20),a.EndDT,111)>@Day_T and convert(nvarchar(20),a.StartDT,111) between @Day_F and @Day_T)
	   ))
    )
    and (isnull(b.OrderType,a.OrderType)=@Order_Type or @Order_Type=0)

	if(@Type=5 or @Type=7)
    begin
       select t1.*, Is_carfix=case isnull(t5.RealAmt,0) when 0 then 'N' else 'Y' end,OrderType_D=isnull(t3.ItemName,'')
	   into #Order_F
	   from @Order_Q t1
	   left outer join ItemCode t3 on t1.OrderType=t3.num and t3.ItemType=326
	   left outer join OrderBudget t5 on t1.Order_Auto=t5.Order_Auto and t5.Type_Auto=1
	   where (OrderType=@Order_Type or @Order_Type=0)
	   and (Inc_Auto=@Inc_Auto or @Inc_Auto=0)  --车种 Category  226


	   ---交强险公司---
	   select t1.EndDT,t2.Order_Auto,t2.Carbase_Auto,t1.Supplier,Ins_EndDT=convert(nvarchar(20),t1.EndDT,111)
	   into #Ins_NN
	   from insure2 t1,#Order_F t2
	   where t1.InsureType=0
	   and t1.Status!=-10
	   and t1.CarBase_Auto=t2.Carbase_Auto
	   and
	   (
	   (convert(nvarchar(20),t1.StartDT,111)&lt;@Day_F and convert(nvarchar(20),t1.EndDT,111)>@Day_T) or
	   (convert(nvarchar(20),t1.StartDT,111)&lt;@Day_F and convert(nvarchar(20),t1.EndDT,111) between @Day_F and @Day_T) or
	   (convert(nvarchar(20),t1.EndDT,111)>@Day_T and convert(nvarchar(20),t1.StartDT,111) between @Day_F and @Day_T)
	   )


	   select  Order_Auto, Carbase_Auto,Ins_EndDT=MAX(Ins_EndDT)
	   into #Ins_NN_
	   from #Ins_NN
	   group by Order_Auto,Carbase_Auto

	   select distinct t1.*,t2.Supplier
	   into #Ins_N
	   from #Ins_NN_ t1,#Ins_NN t2
	   where t1.Carbase_Auto=t2.CarBase_Auto
	   and t1.Ins_EndDT=t2.Ins_EndDT
	   and t1.Order_Auto=t2.Order_Auto

	select d.Order_Auto,case when g.Num = 11 then g.ItemName+ '-'+j.ItemName else g.ItemName end  orderLaw
	into #order_Law
	from (
	select a.Order_Auto, max(c.Registerdt) Registerdt
	from #Order_F a
	LEFT JOIN LawCaseInfo  b ON b.Order_Auto = a.Order_Auto
	left join Law_Register c on c.LawCase_Auto = b.LawCase_Auto
	group by a.Order_Auto
	) d
	left join LawCaseInfo e on e.Order_Auto = d.Order_Auto
	inner join Law_Register f on f.LawCase_Auto = e.LawCase_Auto and f.Registerdt = d.Registerdt
	left join ItemCode g on g.ItemType = 2027 and g.Num = e.[Status]
	left join Law_Closecase h on h.LawCase_Auto = e.LawCase_Auto
	left join ItemCode j on j.ItemType = 2021 and j.Num = h.Closecasetype

	   select t1.*--, Is_carfix=case isnull(t5.RealAmt,0) when 0 then 'N' else 'Y' end,OrderType_D=isnull(t3.ItemName,'')
	   ,Category_D=isnull(t4.ItemName,'') ,Status_D=isnull(t6.ItemName,''),Sales_N=isnull(t7.FName,''),Ins_EndDT=isnull(t8.Ins_EndDT,'')
	   ,Ins_name=isnull(t10.SName,'') ,Inc_Name=isnull(t14.SName,''),t2.MakNo,ClasenName=isnull(t15.ClasenName ,'')
	   ,CusName=isnull(t16.SName,''),OrderStatus_D=case t1.status when 30 then '正常' when 40 then '解约' end
	   ,t17.ItemName CarSourceName,t18.orderLaw
	   into #ttt
	   from #Order_F t1
	   inner join CarBase t2 on t1.Carbase_Auto=t2.CarBase_Auto
	   left outer join ItemCode t3 on t1.OrderType=t3.num and t3.ItemType=326
	   left outer join ItemCode t4 on t2.Category=t4.num and t4.ItemType=226--车种
	   left outer join ItemCode t6 on t2.Status=t6.num and t6.ItemType=233--牌照状态
	   left outer join OrderBudget t5 on t1.Order_Auto=t5.Order_Auto and t5.Type_Auto=1
	   left outer join v_Emp  t7 on t7.User_Auto=t1.Sales_Auto
	   left outer join #Ins_N t8 on t8.Order_Auto=t1.Order_Auto and t2.CarBase_Auto=t8.Carbase_Auto
	   left outer join  supplier t9 on t9.Supplier_Auto=t8.Supplier and t9.SupplierType=1
	   left outer join  TradeItem t10 on t10.TradeItem_Auto=t9.TradeItem_Auto
	   left outer join Inc t14 on t14.Inc_Auto=t1.Inc_Auto
	   left outer join Clasen t15 on t15.Clasen_Auto=t2.Clasen_Auto
	   left outer join  TradeItem t16 on t16.TradeItem_Auto=t1.TradeItem_Auto
	   left outer join  ItemCode t17 on t1.CarSource=t17.num and t17.ItemType=503 --车辆来源
	   left join #order_Law t18 on t18.Order_Auto = t1.Order_Auto
	   order by t1.Inc_Auto,t1.OrderType

	   if(@Type=7 )
	   begin
	   declare
    @createNum int,
    @endNum int,
    @beforeEndNum int

	   --保有台数计算--公务车9 短租2 不计算在内
	   --1.新增保有台数
	      select @createNum=count(*) from #ttt where StartDT between @StartDT and @EndDT and OrderType not in (2,9)
	   --2.期满解约
	      select @endNum=count(*) from #ttt where EndDT between @StartDT and @EndDT and OrderType not in (2,9)
	   --3.提前解约
	      select
		  @beforeEndNum=count(*)
		  from #ttt
		  where
		  EndDT between @StartDT and @EndDT
		  and
		  ResDT between @StartDT and @EndDT
		  and
		  OrderType not in (2,9)

		  select @createNum createNum,@endNum endNum,@beforeEndNum beforeEndNum
	   --4.上个月保有 between DATEADD(m,-1,@StartDT) and DATEADD(m,-1,@EndDT)
	   --本月
	   --select count(*) from #ttt where OrderType not in (2,9)
	   end
	   --exec dbo.xp_GetPage  'select * from #ttt',2,20,1
	   if(@Type=5 )
	   begin
	      exec proc_paged_2part_selectMax '#ttt','*',@pageSize,@page,'Order_Auto',0,null,'Order_Auto',0
	   end
	end

	drop table #Order_F
	drop table #Ins_NN_
	drop table #Ins_NN
	drop table #Ins_N
	drop table #order_Law
	drop table #ttt
    </select>

  <resultMap id="queryLm" type="com.funtl.myshop.plus.provider.domain.CustomerNum">
        <result column="lmCusNum" jdbcType="INTEGER" property="lmCusNum" />
  </resultMap>
  <select id="selectLm" resultMap="queryLm">
    ----S_Credit_ORder
declare
    @Type int = #{param.type},
    @YY int=#{param.yy},
    @MM int=#{param.mm},
    @Order_Type int=#{param.orderType},
    @Inc_Auto bigint=#{param.incAuto},
    @pageSize    int=#{param.pageSize},
    @page        int=#{param.page}

	declare @Day_T nvarchar(40),@YY_T int,@MM_T int
	declare @Order_Q table(Order_Auto nvarchar(10),RentType int,OrderType int,StartDT nvarchar(20),EndDT nvarchar(20),ResDT nvarchar(20)
	,Status int,Inc_Auto bigint,Carbase_Auto bigint,TradeItem_Auto bigint,Sales_Auto bigint,MAmt int,CarSource int,CarDT nvarchar(10),MakDT nvarchar(10))
	select @YY_T=DATEPART(YYYY,getdate())
	select @MM_T=DATEPART(MM,getdate())
   declare @D_Q nvarchar(40),@D_T nvarchar(40),@Day_F nvarchar(40)
   select @D_Q=convert(nvarchar(40),convert(datetime,convert(char(4),@YY)+'/'+convert(char(2),@MM)+'/01'),111)
   select @D_T=convert(nvarchar(40),convert(datetime,convert(char(4),@YY_T)+'/'+convert(char(2),@MM_T)+'/01'),111)
   if(@D_Q>=@D_T)
   begin
      select @Day_T=convert(nvarchar(20),DATEADD(dd,-1,DATEADD(MM,1,@D_T)),111)
	  select @Day_F=convert(nvarchar(20),@D_T,111)
	  select @YY=DATEPART(YY,@Day_T)
	  select @MM=DATEPART(MM,@Day_T)
   end
   if(@D_Q&lt;@D_T)
   begin
      select @Day_T=convert(nvarchar(20),DATEADD(dd,-1,DATEADD(MM,1,@D_Q)),111)
	  select @Day_F=convert(nvarchar(20),@D_Q,111)
   end
   --select Day_T=@Day_T
    insert into @Order_Q(Order_Auto,RentType,OrderType,StartDT,EndDT,ResDT,Status,Inc_Auto,Carbase_Auto,TradeItem_Auto,Sales_Auto,MAmt ,CarSource ,CarDT ,MakDT)
	select a.Order_Auto,a.RentType,isnull(b.OrderType,a.OrderType) OrderType,StartDT=convert(nvarchar(20),a.StartDT,111),EndDT=convert(nvarchar(20),a.EndDT,111)
	,ResDT=convert(nvarchar(20),a.ResDT,111),a.Status,a.Inc_Auto,a.CarBase_Auto,a.TradeItem_Auto,a.Sales_Auto,a.MAmt,b.CarSource,convert(nvarchar(10),c.CarDT,111),convert(nvarchar(10),c.MakDT,111)
	from [order] a
	left join orders b on isnull(a.orders_auto,0) > 0 and b.orders_auto = a.orders_auto
	left join CarBase c on c.CarBase_Auto = a.CarBase_Auto
	where a.OrderType!=3---不含月租
	and
    (
      (a.[Status]=30  and ((a.EndDT&lt;=@Day_T) or (a.EndDT>@Day_T and a.StartDT&lt;=@Day_T))) or
	  (a.[Status]=40 and a.ResDT>@Day_T and (
	   (convert(nvarchar(20),a.StartDT,111)&lt;@Day_F and convert(nvarchar(20),a.EndDT,111)>@Day_T)
	   or (convert(nvarchar(20),a.StartDT,111)&lt;@Day_F and convert(nvarchar(20),a.EndDT,111) between @Day_F and @Day_T) or
	   (convert(nvarchar(20),a.EndDT,111)>@Day_T and convert(nvarchar(20),a.StartDT,111) between @Day_F and @Day_T)
	   ))
    )
    and (isnull(b.OrderType,a.OrderType)=@Order_Type or @Order_Type=0)

	if(@Type=5 or @Type=7)
    begin
       select t1.*, Is_carfix=case isnull(t5.RealAmt,0) when 0 then 'N' else 'Y' end,OrderType_D=isnull(t3.ItemName,'')
	   into #Order_F
	   from @Order_Q t1
	   left outer join ItemCode t3 on t1.OrderType=t3.num and t3.ItemType=326
	   left outer join OrderBudget t5 on t1.Order_Auto=t5.Order_Auto and t5.Type_Auto=1
	   where (OrderType=@Order_Type or @Order_Type=0)
	   and (Inc_Auto=@Inc_Auto or @Inc_Auto=0)  --车种 Category  226


	   ---交强险公司---
	   select t1.EndDT,t2.Order_Auto,t2.Carbase_Auto,t1.Supplier,Ins_EndDT=convert(nvarchar(20),t1.EndDT,111)
	   into #Ins_NN
	   from insure2 t1,#Order_F t2
	   where t1.InsureType=0
	   and t1.Status!=-10
	   and t1.CarBase_Auto=t2.Carbase_Auto
	   and
	   (
	   (convert(nvarchar(20),t1.StartDT,111)&lt;@Day_F and convert(nvarchar(20),t1.EndDT,111)>@Day_T) or
	   (convert(nvarchar(20),t1.StartDT,111)&lt;@Day_F and convert(nvarchar(20),t1.EndDT,111) between @Day_F and @Day_T) or
	   (convert(nvarchar(20),t1.EndDT,111)>@Day_T and convert(nvarchar(20),t1.StartDT,111) between @Day_F and @Day_T)
	   )


	   select  Order_Auto, Carbase_Auto,Ins_EndDT=MAX(Ins_EndDT)
	   into #Ins_NN_
	   from #Ins_NN
	   group by Order_Auto,Carbase_Auto

	   select distinct t1.*,t2.Supplier
	   into #Ins_N
	   from #Ins_NN_ t1,#Ins_NN t2
	   where t1.Carbase_Auto=t2.CarBase_Auto
	   and t1.Ins_EndDT=t2.Ins_EndDT
	   and t1.Order_Auto=t2.Order_Auto

	select d.Order_Auto,case when g.Num = 11 then g.ItemName+ '-'+j.ItemName else g.ItemName end  orderLaw
	into #order_Law
	from (
	select a.Order_Auto, max(c.Registerdt) Registerdt
	from #Order_F a
	LEFT JOIN LawCaseInfo  b ON b.Order_Auto = a.Order_Auto
	left join Law_Register c on c.LawCase_Auto = b.LawCase_Auto
	group by a.Order_Auto
	) d
	left join LawCaseInfo e on e.Order_Auto = d.Order_Auto
	inner join Law_Register f on f.LawCase_Auto = e.LawCase_Auto and f.Registerdt = d.Registerdt
	left join ItemCode g on g.ItemType = 2027 and g.Num = e.[Status]
	left join Law_Closecase h on h.LawCase_Auto = e.LawCase_Auto
	left join ItemCode j on j.ItemType = 2021 and j.Num = h.Closecasetype

	   select t1.*--, Is_carfix=case isnull(t5.RealAmt,0) when 0 then 'N' else 'Y' end,OrderType_D=isnull(t3.ItemName,'')
	   ,Category_D=isnull(t4.ItemName,'') ,Status_D=isnull(t6.ItemName,''),Sales_N=isnull(t7.FName,''),Ins_EndDT=isnull(t8.Ins_EndDT,'')
	   ,Ins_name=isnull(t10.SName,'') ,Inc_Name=isnull(t14.SName,''),t2.MakNo,ClasenName=isnull(t15.ClasenName ,'')
	   ,CusName=isnull(t16.SName,''),OrderStatus_D=case t1.status when 30 then '正常' when 40 then '解约' end
	   ,t17.ItemName CarSourceName,t18.orderLaw
	   into #ttt
	   from #Order_F t1
	   inner join CarBase t2 on t1.Carbase_Auto=t2.CarBase_Auto
	   left outer join ItemCode t3 on t1.OrderType=t3.num and t3.ItemType=326
	   left outer join ItemCode t4 on t2.Category=t4.num and t4.ItemType=226--车种
	   left outer join ItemCode t6 on t2.Status=t6.num and t6.ItemType=233--牌照状态
	   left outer join OrderBudget t5 on t1.Order_Auto=t5.Order_Auto and t5.Type_Auto=1
	   left outer join v_Emp  t7 on t7.User_Auto=t1.Sales_Auto
	   left outer join #Ins_N t8 on t8.Order_Auto=t1.Order_Auto and t2.CarBase_Auto=t8.Carbase_Auto
	   left outer join  supplier t9 on t9.Supplier_Auto=t8.Supplier and t9.SupplierType=1
	   left outer join  TradeItem t10 on t10.TradeItem_Auto=t9.TradeItem_Auto
	   left outer join Inc t14 on t14.Inc_Auto=t1.Inc_Auto
	   left outer join Clasen t15 on t15.Clasen_Auto=t2.Clasen_Auto
	   left outer join  TradeItem t16 on t16.TradeItem_Auto=t1.TradeItem_Auto
	   left outer join  ItemCode t17 on t1.CarSource=t17.num and t17.ItemType=503 --车辆来源
	   left join #order_Law t18 on t18.Order_Auto = t1.Order_Auto
	   order by t1.Inc_Auto,t1.OrderType

	   if(@Type=7 )
	   begin
       --保有台数计算
	   --4.上个月保有
	   select count(*) lmCusNum from #ttt where OrderType not in (2,9)
	   end
	   if(@Type=5 )
	   begin
	      exec proc_paged_2part_selectMax '#ttt','*',@pageSize,@page,'Order_Auto',0,null,'Order_Auto',0
	   end
	end

	drop table #Order_F
	drop table #Ins_NN_
	drop table #Ins_NN
	drop table #Ins_N
	drop table #order_Law
	drop table #ttt
  </select>
</mapper>
