<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.funtl.myshop.plus.provider.mapper.OrderMapper">
  <resultMap id="BaseResultMap" type="com.funtl.myshop.plus.provider.domain.Order">
    <!--@mbg.generated-->
    <!--@Table [Order]-->
    <id column="Order_Auto" jdbcType="BIGINT" property="orderAuto" />
    <result column="Orders_Auto" jdbcType="BIGINT" property="ordersAuto" />
    <result column="TradeItem_Auto" jdbcType="BIGINT" property="tradeItemAuto" />
    <result column="CarBase_Auto" jdbcType="BIGINT" property="carBaseAuto" />
    <result column="Sales_Auto" jdbcType="BIGINT" property="salesAuto" />
    <result column="OrderNo" jdbcType="VARCHAR" property="orderNo" />
    <result column="LinceNo" jdbcType="VARCHAR" property="linceNo" />
    <result column="StartDT" jdbcType="TIMESTAMP" property="startDT" />
    <result column="EndDT" jdbcType="TIMESTAMP" property="endDT" />
    <result column="ResDT" jdbcType="TIMESTAMP" property="resDT" />
    <result column="Status" jdbcType="INTEGER" property="status" />
    <result column="Memo" jdbcType="VARCHAR" property="memo" />
    <result column="Brand_Auto" jdbcType="INTEGER" property="brandAuto" />
    <result column="Clasen_Auto" jdbcType="INTEGER" property="clasenAuto" />
    <result column="ListPrice" jdbcType="DECIMAL" property="listPrice" />
    <result column="DisPrice" jdbcType="DECIMAL" property="disPrice" />
    <result column="GetPrice" jdbcType="DECIMAL" property="getPrice" />
    <result column="Accessary" jdbcType="DECIMAL" property="accessary" />
    <result column="PushMoney" jdbcType="DECIMAL" property="pushMoney" />
    <result column="CarCost" jdbcType="DECIMAL" property="carCost" />
    <result column="RentAmt" jdbcType="DECIMAL" property="rentAmt" />
    <result column="OverAmt" jdbcType="DECIMAL" property="overAmt" />
    <result column="DptAmt" jdbcType="DECIMAL" property="dptAmt" />
    <result column="MM" jdbcType="INTEGER" property="mm" />
    <result column="MAmt" jdbcType="DECIMAL" property="mAmt" />
    <result column="MakNo" jdbcType="VARCHAR" property="makNo" />
    <result column="CarTax" jdbcType="DECIMAL" property="carCost" />
    <result column="InsurePercnt" jdbcType="INTEGER" property="insurePercnt" />
    <result column="IsBusiness" jdbcType="INTEGER" property="isBusiness" />
    <result column="RentType" jdbcType="INTEGER" property="rentType" />
    <result column="UseType" jdbcType="INTEGER" property="useType" />
    <result column="CarSource" jdbcType="INTEGER" property="carSource" />
    <result column="DriverAmt" jdbcType="DECIMAL" property="driverAmt" />
    <result column="OilAmt" jdbcType="DECIMAL" property="oilAmt" />
    <result column="DriveService" jdbcType="DECIMAL" property="driveService" />
    <result column="RateKM" jdbcType="DECIMAL" property="rateKM" />
    <result column="LinceKM" jdbcType="DECIMAL" property="linceKM" />
    <result column="CarMtnAmt" jdbcType="DECIMAL" property="carMtnAmt" />
    <result column="whiel" jdbcType="INTEGER" property="whiel" />
    <result column="OverKM" jdbcType="DECIMAL" property="overKM" />
    <result column="OverKMPayType" jdbcType="INTEGER" property="overKMPayType" />
    <result column="PayMode" jdbcType="INTEGER" property="payMode" />
    <result column="PayDay" jdbcType="INTEGER" property="payDay" />
    <result column="RateRate" jdbcType="DECIMAL" property="rateRate" />
    <result column="RateInsure" jdbcType="DECIMAL" property="rateInsure" />
    <result column="RateInsureD" jdbcType="DECIMAL" property="rateInsured" />
    <result column="RateMCost" jdbcType="DECIMAL" property="rateMCost" />
    <result column="RateYCost" jdbcType="DECIMAL" property="rateYCost" />
    <result column="RateTCost" jdbcType="DECIMAL" property="rateTCost" />
    <result column="RateM" jdbcType="DECIMAL" property="rateM" />
    <result column="RateY" jdbcType="DECIMAL" property="rateY" />
    <result column="RateT" jdbcType="DECIMAL" property="rateT" />
    <result column="RateCost" jdbcType="DECIMAL" property="rateCost" />
    <result column="RateDPN" jdbcType="DECIMAL" property="rateDPN" />
    <result column="RateTax" jdbcType="DECIMAL" property="rateTax" />
    <result column="RateAmt" jdbcType="DECIMAL" property="rentAmt" />
    <result column="FinalRate" jdbcType="DECIMAL" property="finalRate" />
    <result column="FinalInsure" jdbcType="DECIMAL" property="finalInsure" />
    <result column="FinalInsureD" jdbcType="DECIMAL" property="finalInsured" />
    <result column="FinalMCost" jdbcType="DECIMAL" property="finalMCost" />
    <result column="FinalYCost" jdbcType="DECIMAL" property="finalYCost" />
    <result column="FinalTCost" jdbcType="DECIMAL" property="finalTCost" />
    <result column="FinalM" jdbcType="DECIMAL" property="finalM" />
    <result column="FinalY" jdbcType="DECIMAL" property="finalY" />
    <result column="FinalT" jdbcType="DECIMAL" property="finalT" />
    <result column="FinalCost" jdbcType="DECIMAL" property="finalCost" />
    <result column="FinalDPN" jdbcType="DECIMAL" property="finalDPN" />
    <result column="FinalTax" jdbcType="DECIMAL" property="finalTax" />
    <result column="FinalAmt" jdbcType="DECIMAL" property="finalAmt" />
    <result column="RentTotal" jdbcType="DECIMAL" property="rentTotal" />
    <result column="GrossMarginT" jdbcType="DECIMAL" property="grossMarginT" />
    <result column="GrossMargin" jdbcType="DECIMAL" property="grossMargin" />
    <result column="RentRate" jdbcType="DECIMAL" property="rateRate" />
    <result column="CUser" jdbcType="INTEGER" property="cUser" />
    <result column="CDT" jdbcType="TIMESTAMP" property="cDT" />
    <result column="MUser" jdbcType="INTEGER" property="mUser" />
    <result column="MDT" jdbcType="TIMESTAMP" property="mDT" />
    <result column="CustSource" jdbcType="INTEGER" property="custSource" />
    <result column="Arrange" jdbcType="DECIMAL" property="arrange" />
    <result column="ArrangeDay" jdbcType="BIGINT" property="arrangeDay" />
    <result column="Inc_Auto" jdbcType="BIGINT" property="incAuto" />
    <result column="RealRate" jdbcType="DECIMAL" property="realRate" />
    <result column="RealGMT" jdbcType="DECIMAL" property="realGMT" />
    <result column="RealGM" jdbcType="DECIMAL" property="realGM" />
    <result column="RealRentRate" jdbcType="DECIMAL" property="realRentRate" />
    <result column="MakNoCost" jdbcType="DECIMAL" property="makNoCost" />
    <result column="MakNoOverAmt" jdbcType="DECIMAL" property="makNoOverAmt" />
    <result column="A1" jdbcType="VARCHAR" property="a1" />
    <result column="B1" jdbcType="VARCHAR" property="b1" />
    <result column="B2" jdbcType="VARCHAR" property="b2" />
    <result column="B3" jdbcType="VARCHAR" property="b3" />
    <result column="B4" jdbcType="VARCHAR" property="b4" />
    <result column="IsCHK" jdbcType="INTEGER" property="isChk" />
    <result column="OrderType" jdbcType="INTEGER" property="orderType" />
    <result column="InvDT" jdbcType="INTEGER" property="invDT" />
    <result column="InvStop" jdbcType="INTEGER" property="invStop" />
    <result column="InvStopMemo" jdbcType="VARCHAR" property="invStopMemo" />
    <result column="StampTax" jdbcType="DECIMAL" property="stampTax" />
    <result column="SellCarTax" jdbcType="DECIMAL" property="sellCarTax" />
    <result column="IRR" jdbcType="DECIMAL" property="irr" />
    <result column="NPV" jdbcType="DECIMAL" property="npv" />
    <result column="TrnsFee" jdbcType="DECIMAL" property="trnsFee" />
    <result column="NeedFile" jdbcType="BIGINT" property="needFile" />
    <result column="MakeFile" jdbcType="BIGINT" property="makeFile" />
    <result column="NeedFileNum" jdbcType="BIGINT" property="needFileNum" />
    <result column="MakeFileNum" jdbcType="BIGINT" property="makeFileNum" />
    <result column="RentAmtReal" jdbcType="DECIMAL" property="rentAmtReal" />
    <result column="Sub_Auto" jdbcType="BIGINT" property="subAuto" />
    <result column="RealCarCost" jdbcType="DECIMAL" property="realCarCost" />
    <result column="CollMemo" jdbcType="VARCHAR" property="collMemo" />
    <result column="DPNMAmt" jdbcType="DECIMAL" property="dpnMAmt" />
    <result column="IncVirCardNo" jdbcType="VARCHAR" property="incVirCardNo" />
    <result column="RealDptAmt" jdbcType="DECIMAL" property="realDptAmt" />
    <result column="RealDptDT" jdbcType="TIMESTAMP" property="realDptDT" />
    <result column="RealDptISPrinter" jdbcType="INTEGER" property="realDptISprinter" />
    <result column="DptPrinterDT" jdbcType="TIMESTAMP" property="dptPrinterDT" />
    <result column="DptRemark" jdbcType="VARCHAR" property="dptPrinterDT" />
    <result column="OrderMemo" jdbcType="VARCHAR" property="orderMemo" />
    <result column="C1" jdbcType="VARCHAR" property="c1" />
    <result column="C2" jdbcType="VARCHAR" property="c2" />
    <result column="C3" jdbcType="VARCHAR" property="c3" />
    <result column="D1" jdbcType="VARCHAR" property="d1" />
    <result column="D2" jdbcType="VARCHAR" property="d2" />
    <result column="D3" jdbcType="VARCHAR" property="d3" />
    <result column="D4" jdbcType="VARCHAR" property="d4" />
    <result column="D5" jdbcType="VARCHAR" property="d5" />
    <result column="TaxMode" jdbcType="INTEGER" property="taxMode" />
    <result column="TaxRate" jdbcType="DECIMAL" property="taxRate" />
    <result column="chkListPrice" jdbcType="INTEGER" property="chkListPrice" />
    <result column="BoundDT" jdbcType="TIMESTAMP" property="boundDT" />
    <result column="BoundStatus" jdbcType="INTEGER" property="bonusStatus" />
    <result column="JCDT" jdbcType="TIMESTAMP" property="jcDT" />
    <result column="IsMerit" jdbcType="INTEGER" property="isMerit" />
    <result column="RunDT" jdbcType="TIMESTAMP" property="runDT" />
    <result column="YJCDT" jdbcType="TIMESTAMP" property="yjcDT" />
    <result column="YJSales" jdbcType="INTEGER" property="yjSales" />
    <result column="YJOrg" jdbcType="INTEGER" property="yjOrg" />
    <result column="Scooter" jdbcType="VARCHAR" property="scooter" />
    <result column="DisType" jdbcType="INTEGER" property="disPrice" />
    <result column="InvStopEndDT" jdbcType="TIMESTAMP" property="invStopMemo" />
    <result column="IsBonus" jdbcType="INTEGER" property="isBonus" />
    <result column="IsRemoveOverdue" jdbcType="INTEGER" property="isRemoveOverdue" />
    <result column="BonusStatus" jdbcType="INTEGER" property="bonusStatus" />
    <result column="BonusYY" jdbcType="INTEGER" property="bonusYY" />
    <result column="BonusMM" jdbcType="INTEGER" property="bonusMM" />
    <result column="BonusAmt" jdbcType="DECIMAL" property="bonusAmt" />
    <result column="IsLawEnd" jdbcType="INTEGER" property="isLawEnd" />
    <result column="ReletMakno" jdbcType="VARCHAR" property="reletMakNo" />
    <result column="IsRelet" jdbcType="INTEGER" property="isRelet" />
    <result column="DptAmtTrnDT" jdbcType="TIMESTAMP" property="dptAmtTrnDT" />
    <result column="BonusRate" jdbcType="DECIMAL" property="bonusRate" />
    <result column="BonusCarCost" jdbcType="DECIMAL" property="bonusCarCost" />
    <result column="IsBlack" jdbcType="INTEGER" property="isBlack" />
    <result column="BlackDT" jdbcType="TIMESTAMP" property="blackDT" />
    <result column="OutFee" jdbcType="DECIMAL" property="outFee" />
    <result column="FinanceFee" jdbcType="DECIMAL" property="financeFee" />
    <result column="UrgentFee" jdbcType="DECIMAL" property="urgentFee" />
    <result column="QJRemark" jdbcType="VARCHAR" property="qJRemark" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--@mbg.generated-->
    Order_Auto, Orders_Auto, TradeItem_Auto, CarBase_Auto, Sales_Auto, OrderNo, LinceNo,
    StartDT, EndDT, ResDT, [Status], Memo, Brand_Auto, Clasen_Auto, ListPrice, DisPrice,
    GetPrice, Accessary, PushMoney, CarCost, RentAmt, OverAmt, DptAmt, MM, MAmt, MakNo,
    CarTax, InsurePercnt, IsBusiness, RentType, UseType, CarSource, DriverAmt, OilAmt,
    DriveService, RateKM, LinceKM, CarMtnAmt, whiel, OverKM, OverKMPayType, PayMode,
    PayDay, RateRate, RateInsure, RateInsureD, RateMCost, RateYCost, RateTCost, RateM,
    RateY, RateT, RateCost, RateDPN, RateTax, RateAmt, FinalRate, FinalInsure, FinalInsureD,
    FinalMCost, FinalYCost, FinalTCost, FinalM, FinalY, FinalT, FinalCost, FinalDPN,
    FinalTax, FinalAmt, RentTotal, GrossMarginT, GrossMargin, RentRate, CUser, CDT, MUser,
    MDT, CustSource, Arrange, ArrangeDay, Inc_Auto, RealRate, RealGMT, RealGM, RealRentRate,
    MakNoCost, MakNoOverAmt, A1, B1, B2, B3, B4, IsCHK, OrderType, InvDT, InvStop, InvStopMemo,
    StampTax, SellCarTax, IRR, NPV, TrnsFee, NeedFile, MakeFile, NeedFileNum, MakeFileNum,
    RentAmtReal, Sub_Auto, RealCarCost, CollMemo, DPNMAmt, IncVirCardNo, RealDptAmt,
    RealDptDT, RealDptISPrinter, DptPrinterDT, DptRemark, OrderMemo, C1, C2, C3, D1,
    D2, D3, D4, D5, TaxMode, TaxRate, chkListPrice, BoundDT, BoundStatus, JCDT, IsMerit,
    RunDT, YJCDT, YJSales, YJOrg, Scooter, DisType, InvStopEndDT, IsBonus, IsRemoveOverdue,
    BonusStatus, BonusYY, BonusMM, BonusAmt, IsLawEnd, ReletMakno, IsRelet, DptAmtTrnDT,
    BonusRate, BonusCarCost, IsBlack, BlackDT, OutFee, FinanceFee, UrgentFee, QJRemark
  </sql>

  <resultMap id="queryCaseProList" extends="BaseResultMap" type="com.funtl.myshop.plus.provider.domain.CaseProList">
    <result column="CompanyName" jdbcType="VARCHAR" property="companyName" />
    <result column="DepNAme" jdbcType="VARCHAR" property="depNAme" />
    <result column="FNAme" jdbcType="VARCHAR" property="fNAme" />
    <result column="CustName" jdbcType="VARCHAR" property="custName" />
    <result column="SName" jdbcType="VARCHAR" property="sName" />
    <result column="ClasenName" jdbcType="VARCHAR" property="clasenName" />
    <result column="CustSourceName" jdbcType="VARCHAR" property="custSourceName" />
    <result column="RentTypeName" jdbcType="VARCHAR" property="rentTypeName" />
    <result column="OrderTypeName" jdbcType="VARCHAR" property="orderTypeName" />
    <result column="ListPrice" jdbcType="DECIMAL" property="listPrice" />
    <result column="SalesAMT" jdbcType="DECIMAL" property="salesAMT" />
    <result column="CarMtnAmt" jdbcType="DECIMAL" property="carMtnAmt" />
    <result column="EndDT" jdbcType="TIMESTAMP" property="endDT" />
    <result column="RealDptDT" jdbcType="TIMESTAMP" property="realDptDT" />
    <result column="MakDT" jdbcType="TIMESTAMP" property="makDT" />
    <result column="JCDT" jdbcType="TIMESTAMP" property="jcDT" />
    <result column="ContractSignet" jdbcType="TIMESTAMP" property="contractSignet" />
    <result column="OrderStatus" jdbcType="VARCHAR" property="orderStatus" />
    <result column="QiPiao" jdbcType="DECIMAL" property="qiPiao" />
    <result column="IsTruck" jdbcType="VARCHAR" property="isTruck" />
    <result column="InsureMM" jdbcType="INTEGER" property="insureMM" />
    <result column="InsureAmt" jdbcType="DECIMAL" property="insureAmt" />
  </resultMap>
    <select id="selectCaseProList" resultMap="queryCaseProList">
      declare
      @inc int,--公司别
      @type int,--查询类别
      @year int,--年份
      @month int,--月份
      @flag int,--单选按钮
      @customer varchar(100)--输入条件
      set   @inc = #{caseProQueryParam.inc}
      set	@type = #{caseProQueryParam.type}
      set	@year = #{caseProQueryParam.year}
      set	@month = #{caseProQueryParam.year}
      set	@flag = #{caseProQueryParam.flag}
      set	@customer = #{caseProQueryParam.customer}
      <!--<if test="caseProQueryParam.customer == null or caseProQueryParam.customer == ''">
        set @customer = ''
      </if>-->
      BEGIN
      declare @order table(
      order_auto bigint,
      orders_auto bigint
      )

      insert into @order
      select distinct a.Order_Auto,a.orders_auto
      from [order] a  (nolock)
      inner join tradeitem c  (nolock) on a.tradeitem_auto=c.tradeitem_auto
      left join Credit_Order f  (nolock) on a.Orders_Auto=f.Orders_Auto
      inner join CreditMainInfo g  (nolock) on f.CreditMain_Auto=g.CreditMain_Auto and g.CreditStatus>=10
      left join BookCar i (nolock)  on g.CreditMain_Auto=i.CreditMain_Auto
      left join BookCarNote k (nolock)  on k.CreditMain_Auto=g.CreditMain_Auto and k.Status=1
      where  a.OrderType in(1,5,6) and (a.Inc_Auto=@inc or @inc=0) and
      (
      (@customer!='' and c.FName like '%'+@customer+'%' and (a.YJCDT is null or a.JCDT is null)) or
      ((@customer ='') and (
      (
      (@flag=0 and
      ((@type=1 and
      (
      (isnull(a.DptAmt,0)>0 and ( ((@month between 2 and 11) and ((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month-1 and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )>=21) or (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )&lt;=20)))
      or (@month=1 and DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )&lt;=20)
      or (@month=12 and ((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month-1 and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )>=21) or (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month))) ) and DATEPART(YYYY,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@year)
      or
      (isnull(a.DptAmt,0)=0 and ( ((@month between 2 and 11) and ((DATEPART(MM,i.EndDT)=@month-1 and DATEPART(DD,i.EndDT)>=21) or (DATEPART(MM,i.EndDT)=@month and DATEPART(DD,i.EndDT)&lt;=20)))
      or (@month=1 and DATEPART(MM,i.EndDT)=@month and DATEPART(DD,i.EndDT)&lt;=20)
      or (@month=12 and ((DATEPART(MM,i.EndDT)=@month-1 and DATEPART(DD,i.EndDT)>=21) or (DATEPART(MM,i.EndDT)=@month))) ) and DATEPART(YYYY,i.EndDT)=@year)
      )
      )
      or (@type=2 and ( ((@month between 2 and 11) and ((DATEPART(MM,a.JCDT)=@month-1 and DATEPART(DD,a.JCDT)>=21) or (DATEPART(MM,a.JCDT)=@month and DATEPART(DD,a.JCDT)&lt;=20)) )
      or (@month=1 and DATEPART(MM,a.JCDT)=@month and DATEPART(DD,a.JCDT)&lt;=20)
      or (@month=12 and ((DATEPART(MM,a.JCDT)=@month-1 and DATEPART(DD,a.JCDT)>=21) or (DATEPART(MM,a.JCDT)=@month))) )  and DATEPART(YYYY,a.JCDT)=@year)
      or (@type=3 and ( ((@month between 2 and 11) and ((DATEPART(MM,a.BoundDT)=@month-1 and DATEPART(DD,a.BoundDT)>=21) or (DATEPART(MM,a.BoundDT)=@month and DATEPART(DD,a.BoundDT)&lt;=20)) )
      or (@month=1 and DATEPART(MM,a.BoundDT)=@month and DATEPART(DD,a.BoundDT)&lt;=20)
      or (@month=12 and ((DATEPART(MM,a.BoundDT)=@month-1 and DATEPART(DD,a.BoundDT)>=21) or (DATEPART(MM,a.BoundDT)=@month))) )  and DATEPART(YYYY,a.BoundDT)=@year)
      or (@type=4 and ( ((@month between 2 and 11) and ((DATEPART(MM,a.YJCDT)=@month-1 and DATEPART(DD,a.YJCDT)>=21) or (DATEPART(MM,a.YJCDT)=@month and DATEPART(DD,a.YJCDT)&lt;=20)) )
      or (@month=1 and DATEPART(MM,a.YJCDT)=@month and DATEPART(DD,a.YJCDT)&lt;=20)
      or (@month=12 and ((DATEPART(MM,a.YJCDT)=@month-1 and DATEPART(DD,a.YJCDT)>=21) or (DATEPART(MM,a.YJCDT)=@month))) )  and DATEPART(YYYY,a.YJCDT)=@year)
      or (
      @type=5 and isnull(case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end,'') !='' and (
      (( ((@month between 2 and 11) and ((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month-1 and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )>=21) or (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )&lt;=20)))
      or (@month=1 and DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )&lt;=20)
      or (@month=12 and ((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month-1 and DATEPART(DD,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )>=21) or (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month))) ) and DATEPART(YYYY,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@year
      )
      or
      (( ((@month between 2 and 11) and ((DATEPART(MM,a.JCDT)=@month-1 and DATEPART(DD,a.JCDT)>=21) or (DATEPART(MM,a.JCDT)=@month and DATEPART(DD,a.JCDT)&lt;=20)) )
      or (@month=1 and DATEPART(MM,a.JCDT)=@month and DATEPART(DD,a.JCDT)&lt;=20)
      or (@month=12 and ((DATEPART(MM,a.JCDT)=@month-1 and DATEPART(DD,a.JCDT)>=21) or (DATEPART(MM,a.JCDT)=@month))) )  and DATEPART(YYYY,a.JCDT)=@year
      )
      or (a.JCDT is null )
      )
      )
      )
      )
      or (@flag=1 and
      (
      (@type=1 and (DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(YYYY,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@year))
      or (@type=2 and (DATEPART(MM,a.JCDT)=@month and DATEPART(YYYY,a.JCDT)=@year))
      or (@type=3 and (DATEPART(MM,a.BoundDT)=@month and DATEPART(YYYY,a.BoundDT)=@year))
      or (@type=4 and (DATEPART(MM,a.YJCDT)=@month and DATEPART(YYYY,a.YJCDT)=@year))
      or (
      @type=5 and isnull(case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end,'') !='' and (
      ((DATEPART(MM,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@month and DATEPART(YYYY,case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end )=@year))
      or
      ((DATEPART(MM,a.JCDT)=@month and DATEPART(YYYY,a.JCDT)=@year))
      or (a.JCDT is null)
      )
      )
      ))
      )
      or (case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when RTRIM(k.txtruzhang1) = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end &lt; '2013/11/21' and a.Order_Auto in(6064,4325,4326,6067,6061,5963,6065,6017,6068,5984,5993,5962,6047,5981,6002,5870,6013,6014,6071,6042)
      and (a.JCDT='' or a.JCDT is null) and @type!=4
      )
      ))
      )

      select CompanyName=h.SName,b1.DepName,b.FNAme,CustName=c.FName,c.SName,L.FactoryBrandName+'-'+ ClasenName ClasenName,d.MakNo,a.Order_Auto
      ,CustSourceName=dbo.f_GetItemName(313,a.CustSource),a.MM,a.MAmt,SalesAMT=a.MM*a.MAMT,case when a.IsBonus = 1 or a.Status >= 30 or a.IsCHK = 1 then BonusRate else 0.00 end BonusRate
      ,CarMtnAmt,g.SignedTime,i.EndDT
      ,RealDptDT=case when k.BookCarNote_Auto is not null then case when case when k.txtzongbaozhengjin = '' then 0.00 else convert(decimal(16,2), k.txtzongbaozhengjin) end > case when k.txtruzhang1 = '' then 0.00 else convert(decimal(16,2),k.txtruzhang1) end then null else k.txtsumbailgetdate end else null end
      ,d.MakDT,
      --a.JCDT,
      ISNULL(a.JCDT,m.deliveryDT) as JCDT,
      g.ContractSignet,g.CreditMain_Auto,a.BoundDT
      ,OrderStatus=case when j.OrderStatus=10 then '变更中' when j.OrderStatus>=20 then '完成' end
      ,QiPiao=case when j.OrderType = 8 then a.CarCost-a.StampTax else (a.ListPrice-a.DisPrice-case when a.RentType = 2 and isnull(j.OverAmt_Y,0) > 0 then j.OverAmt else a.OverAmt end) end,a.YJCDT
      ,RentTypeName=dbo.f_GetItemName(314,a.RentType)
      ,a.ListPrice
      ,OrderTypeName = n.ItemName --case a.OrderType when 1 then '长租' when 5 then '融资' when 9 then '公务车' else '' end
      ,a.BonusStatus
      ,case when o.ItemName like '%货车%' then '货车' else case when j.Onetime = 1 then '一次性' else p.ItemName end end IsTruck
      ,q.InsureMM
      ,q.InsureAmt
      from @order aa
      left join [order] a  (nolock) on a.Order_Auto = aa.order_auto
      inner join v_emp b (nolock)  on a.YJSales=b.User_Auto--a.Sales_auto=b.User_Auto  YJSales,YJOrg
      inner join AspNet.dbo.Org b1 (nolock)  on b1.Org_Auto = a.YJOrg
      inner join tradeitem c  (nolock) on a.tradeitem_auto=c.tradeitem_auto
      inner join Carbase d  (nolock) on a.Carbase_auto=d.Carbase_auto
      inner join Clasen e  (nolock) on a.clasen_auto=e.clasen_auto
      inner join Inc h  (nolock) on a.Inc_Auto=h.Inc_Auto
      left join FactoryBrand l  (nolock) on l.FactoryBrand_Auto=d.FactoryBrand_Auto
      left join Credit_Order f  (nolock) on a.Orders_Auto=f.Orders_Auto
      left join CreditMainInfo g  (nolock) on f.CreditMain_Auto=g.CreditMain_Auto
      left join BookCar i  (nolock) on g.CreditMain_Auto=i.CreditMain_Auto
      left join Orders j  (nolock) on a.Orders_Auto=j.Orders_Auto
      LEFT JOIN DEliverycar m  (nolock) on m.Order_auto=a.Order_Auto AND M.[Status]=1 AND M.ReturnVisit_Auto>0
      left join BookCarNote k (nolock)  on k.CreditMain_Auto=g.CreditMain_Auto and k.Status=1
      left join ItemCode n  (nolock) on n.ItemType = 326 and n.Num = j.OrderType
      left join ItemCode o  (nolock) on o.ItemType = 410 and o.Num = d.InsurePercnt
      left join ItemCode p  (nolock) on p.ItemType = 503 and p.Num = j.CarSource
      left join (	select k1.Order_Auto,
      sum(case when k3.InsureType = 2 then 1 else 0 end * 12  - case when k2.MM%12 > 0 and k3.InsureType = 2 and k3.InsureYear = k2.MM/12 then 12 - k2.MM%12 else 0 end) InsureMM ,
      sum(case when k3.InsureType = 2 and k3.InsureYear = 1 then k3.InsureRealAmt else 0 end) InsureAmt
      from @Order k1
      left join orders k2 on k2.Orders_Auto = k1.Orders_Auto
      left join OrdersInsureList k3 on k3.Orders_Auto = k2.Orders_Auto and k3.InsureType = 2
      group by k1.Order_Auto,k2.MM,k2.IsCustomerCare)q on q.order_auto = a.Order_Auto

      Order by DepName,FName
      end
    </select>
</mapper>
